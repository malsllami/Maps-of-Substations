<!DOCTYPE html>

<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#e8a54b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" id="manifest-placeholder">
    <title>Ù†Ø¸Ø§Ù… Ù…Ø­Ø·Ø§Øª SEC - Ø¬Ø¯Ø©</title>
    <script>
        const manifest = {"name":"Ù†Ø¸Ø§Ù… Ù…Ø­Ø·Ø§Øª SEC","short_name":"SEC","start_url":"./","display":"standalone","background_color":"#1e3a5f","theme_color":"#e8a54b","icons":[{"src":"data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23e8a54b' width='100' height='100' rx='20'/><text x='50' y='65' text-anchor='middle' fill='white' font-size='50'>âš¡</text></svg>","sizes":"192x192","type":"image/svg+xml"}]};
        const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
        document.getElementById('manifest-placeholder').setAttribute('href', URL.createObjectURL(blob));
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>
    <style>
        :root{--sec-orange:#e8a54b;--sec-blue:#1e3a5f;--sec-blue-light:#2d4a6f;--sec-blue-lighter:#5b8fb9;--success:#5cb85c;--warning:#f0c36d;--danger:#e57373;--bg-dark:#0f1c2e;--bg-card:#1a2d47;--bg-input:#243447;--text-primary:#fff;--text-secondary:#a0b4c8;--border:#3d5a80}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Tajawal',sans-serif;background:var(--bg-dark);color:var(--text-primary);min-height:100vh}
        .page{display:none;min-height:100vh}.page.active{display:block}
        .login-page{display:flex;align-items:center;justify-content:center;padding:1rem;background:linear-gradient(135deg,var(--bg-dark),var(--sec-blue))}
        .login-card{background:var(--bg-card);border-radius:1rem;padding:2rem;width:100%;max-width:400px;box-shadow:0 10px 40px rgba(0,0,0,0.3)}
        .login-logo{text-align:center;margin-bottom:1.5rem}
        .login-logo .icon{font-size:3rem;background:linear-gradient(135deg,#e8a54b,#d4923a);width:80px;height:80px;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 1rem}
        .login-logo h1{font-size:1.5rem;color:var(--sec-orange)}
        .login-logo p{color:var(--text-secondary);font-size:0.85rem}
        .tabs{display:flex;margin-bottom:1.5rem;background:var(--bg-input);border-radius:0.5rem;padding:0.25rem}
        .tab{flex:1;padding:0.75rem;text-align:center;border-radius:0.4rem;cursor:pointer;transition:0.3s;color:var(--text-secondary)}
        .tab.active{background:linear-gradient(135deg,#e8a54b,#d4923a);color:#fff;font-weight:600}
        .tab-content{display:none}.tab-content.active{display:block}
        .form-group{margin-bottom:1rem}
        .form-group label{display:block;margin-bottom:0.5rem;color:var(--text-secondary);font-size:0.85rem}
        .form-group input,.form-group select,.form-group textarea{width:100%;padding:0.75rem 1rem;background:var(--bg-input);border:2px solid var(--border);border-radius:0.5rem;color:var(--text-primary);font-family:'Tajawal',sans-serif;font-size:1rem}
        .form-group input:focus,.form-group select:focus{outline:none;border-color:var(--sec-orange)}
        .form-group input.valid{border-color:var(--success)}
        .form-group input.error{border-color:var(--danger)}
        .input-hint{font-size:0.75rem;color:var(--text-secondary);margin-top:0.25rem}
        .input-hint.success{color:var(--success)}.input-hint.error{color:var(--danger)}
        .form-row{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
        .btn{width:100%;padding:0.85rem;border:none;border-radius:0.5rem;font-family:'Tajawal',sans-serif;font-size:1rem;font-weight:600;cursor:pointer;transition:0.3s;display:flex;align-items:center;justify-content:center;gap:0.5rem}
        .btn:disabled{opacity:0.5;cursor:not-allowed}
        .btn-primary{background:linear-gradient(135deg,#e8a54b,#d4923a);color:#fff}
        .btn-primary:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 5px 20px rgba(232,165,75,0.4)}
        .btn-success{background:var(--success);color:#fff}
        .btn-secondary{background:var(--bg-input);color:var(--text-primary);border:1px solid var(--border)}
        .btn-warning{background:var(--warning);color:#1a1a1a}
        .btn-danger{background:var(--danger);color:#fff}
        .admin-link{text-align:center;margin-top:1.5rem}
        .admin-link a{color:var(--text-secondary);font-size:0.85rem;text-decoration:none}
        .admin-link a:hover{color:var(--sec-orange)}
        .header{background:var(--bg-card);padding:0.75rem 1rem;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100}
        .header-right{display:flex;align-items:center;gap:0.75rem}
        .header-right .logo{font-size:1.5rem}
        .header-right h1{font-size:1rem;color:var(--sec-orange)}
        .header-right p{font-size:0.7rem;color:var(--text-secondary)}
        .header-left{display:flex;align-items:center;gap:0.75rem;flex-wrap:wrap}
        .whatsapp-btn{display:flex;align-items:center;justify-content:center;width:2.2rem;height:2.2rem;background:#25D366;border-radius:50%;border:none;cursor:pointer;transition:0.3s}
        .whatsapp-btn:hover{transform:scale(1.1)}
        .whatsapp-btn svg{width:1.3rem;height:1.3rem;fill:#fff}
        .cache-status{display:flex;align-items:center;gap:0.4rem;padding:0.4rem 0.75rem;background:var(--bg-input);border-radius:0.5rem;font-size:0.75rem;cursor:pointer;transition:0.3s}
        .cache-status:hover{background:var(--sec-orange)}
        .cache-status.loaded .cache-text{color:var(--success)}
        .cache-status.loading .cache-text{color:var(--warning)}
        .cache-status.error .cache-text{color:var(--danger)}
        .user-info{display:flex;align-items:center;gap:0.5rem;padding:0.4rem 0.75rem;background:var(--bg-input);border-radius:0.5rem}
        .user-avatar{width:2rem;height:2rem;background:var(--sec-orange);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700}
        .user-name{font-weight:600;font-size:0.85rem}
        .user-type{font-size:0.7rem;color:var(--text-secondary)}
        .logout-btn{background:transparent;border:1px solid var(--danger);color:var(--danger);padding:0.4rem 0.75rem;border-radius:0.5rem;cursor:pointer;display:flex;align-items:center;gap:0.3rem;font-family:'Tajawal',sans-serif;font-size:0.8rem;transition:0.3s}
        .logout-btn:hover{background:var(--danger);color:#fff}
        .logout-btn svg{width:1rem;height:1rem;fill:currentColor}
        .admin-toggle-btn{background:linear-gradient(135deg,#9b59b6,#8e44ad);color:#fff;border:none;padding:0.4rem 0.75rem;border-radius:0.5rem;cursor:pointer;font-family:'Tajawal',sans-serif;font-size:0.8rem;font-weight:600;transition:0.3s;display:flex;align-items:center;gap:0.3rem}
        .admin-toggle-btn:hover{transform:scale(1.05);box-shadow:0 3px 10px rgba(155,89,182,0.4)}
        .back-to-dashboard-btn{background:linear-gradient(135deg,#3498db,#2980b9);color:#fff;border:none;padding:0.4rem 0.75rem;border-radius:0.5rem;cursor:pointer;font-family:'Tajawal',sans-serif;font-size:0.8rem;font-weight:600;transition:0.3s;display:flex;align-items:center;gap:0.3rem}
        .back-to-dashboard-btn:hover{transform:scale(1.05)}
        .admin-toggle-btn{background:linear-gradient(135deg,#9b59b6,#8e44ad);color:#fff;border:none;padding:0.4rem 0.75rem;border-radius:0.5rem;cursor:pointer;font-family:'Tajawal',sans-serif;font-size:0.8rem;font-weight:600;transition:0.3s;display:flex;align-items:center;gap:0.3rem}
        .admin-toggle-btn:hover{background:linear-gradient(135deg,#8e44ad,#7d3c98);transform:scale(1.05)}
        .employee-toggle-btn{background:linear-gradient(135deg,#3498db,#2980b9);color:#fff;border:none;padding:0.4rem 0.75rem;border-radius:0.5rem;cursor:pointer;font-family:'Tajawal',sans-serif;font-size:0.8rem;font-weight:600;transition:0.3s;display:flex;align-items:center;gap:0.3rem}
        .employee-toggle-btn:hover{background:linear-gradient(135deg,#2980b9,#1f6dad);transform:scale(1.05)}
        .main-content{padding:1rem;max-width:1200px;margin:0 auto}
        .search-section{background:var(--bg-card);border-radius:1rem;padding:1.25rem;margin-bottom:1rem}
        .search-section h2{display:flex;align-items:center;gap:0.5rem;font-size:1.1rem;margin-bottom:1rem;color:var(--sec-orange)}
        .search-section h2 svg{width:1.25rem;height:1.25rem;fill:var(--sec-orange)}
        .search-box{display:flex;gap:0.5rem;margin-bottom:1rem}
        .search-box input{flex:1;padding:0.75rem 1rem;background:var(--bg-input);border:2px solid var(--border);border-radius:0.5rem;color:var(--text-primary);font-size:1rem;font-family:'Tajawal',sans-serif}
        .search-box input:focus{outline:none;border-color:var(--sec-orange)}
        .action-buttons{display:flex;flex-wrap:wrap;gap:0.5rem}
        .action-btn{display:flex;align-items:center;gap:0.4rem;padding:0.6rem 1rem;border:none;border-radius:0.5rem;font-family:'Tajawal',sans-serif;font-size:0.85rem;font-weight:600;cursor:pointer;transition:0.3s}
        .action-btn svg{width:1.1rem;height:1.1rem;fill:currentColor}
        .action-btn:hover{transform:translateY(-2px)}
        .btn-search{background:var(--sec-orange);color:#fff}
        .btn-add{background:var(--success);color:#fff}
        .btn-add-sub{background:var(--sec-blue-lighter);color:#fff}
        .btn-edit{background:var(--warning);color:#1a1a1a}
        .btn-fault{background:var(--danger);color:#fff}
        @media(max-width:480px){.action-btn{font-size:0.75rem;padding:0.5rem 0.6rem}.action-btn svg{width:1rem;height:1rem}.action-btn span{font-size:0.7rem}.header-left{gap:0.4rem}.user-info{padding:0.3rem 0.5rem}.cache-status{padding:0.3rem 0.5rem;font-size:0.7rem}}
        .results-section{background:var(--bg-card);border-radius:1rem;padding:1.25rem;margin-bottom:1rem}
        .results-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}
        .results-header h3{font-size:1rem;color:var(--sec-orange)}
        .results-count{background:var(--sec-orange);color:#fff;padding:0.25rem 0.75rem;border-radius:1rem;font-size:0.8rem}
        .results-table-wrapper{overflow-x:auto}
        .results-table{width:100%;border-collapse:collapse;font-size:0.85rem}
        .results-table th,.results-table td{padding:0.75rem;text-align:right;border-bottom:1px solid var(--border)}
        .results-table th{background:var(--bg-input);color:var(--text-secondary);font-weight:600}
        .results-table tr:hover{background:var(--bg-input)}
        .type-badge{display:inline-block;padding:0.2rem 0.5rem;border-radius:0.25rem;font-size:0.7rem;font-weight:600}
        .type-distribution{background:var(--sec-orange);color:#fff}
        .type-substation{background:var(--sec-blue-lighter);color:#fff}
        .map-link{display:inline-flex;align-items:center;gap:0.25rem;color:var(--sec-blue-lighter);text-decoration:none;font-size:0.8rem}
        .map-link:hover{color:var(--sec-orange)}
        .map-link svg{width:1rem;height:1rem;fill:currentColor}
        .not-found-card{text-align:center;padding:2rem}
        .not-found-card h4{color:var(--danger);margin-bottom:0.5rem}
        .searched-number{font-size:1.5rem;font-weight:700;color:var(--text-secondary)}
        .feeder-toggle{display:flex;gap:0.5rem;margin-top:1rem;flex-wrap:wrap}
        .feeder-btn{display:flex;align-items:center;gap:0.4rem;padding:0.6rem 1rem;background:var(--bg-input);border:2px solid var(--border);border-radius:0.5rem;color:var(--text-secondary);font-family:'Tajawal',sans-serif;font-size:0.8rem;cursor:pointer;transition:0.3s}
        .feeder-btn.active{background:var(--sec-orange);border-color:var(--sec-orange);color:#fff}
        .feeder-btn svg{width:1rem;height:1rem;fill:currentColor}
        .map-section{background:var(--bg-card);border-radius:1rem;padding:1.25rem;margin-bottom:1rem}
        .map-section h3{font-size:1rem;color:var(--sec-orange);margin-bottom:1rem;display:flex;align-items:center;gap:0.5rem}
        .map-container{height:300px;border-radius:0.75rem;overflow:hidden}
        .leaflet-container{background:var(--bg-input)}
        .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:1000;padding:1rem;overflow-y:auto}
        .modal-overlay.active{display:flex}
        .modal{background:var(--bg-card);border-radius:1rem;width:100%;max-width:500px;max-height:90vh;overflow-y:auto}
        .modal-header{display:flex;justify-content:space-between;align-items:center;padding:1rem 1.25rem;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--bg-card);z-index:10}
        .modal-header h3{display:flex;align-items:center;gap:0.5rem;font-size:1.1rem;color:var(--sec-orange)}
        .modal-header h3 svg{width:1.25rem;height:1.25rem;fill:var(--sec-orange)}
        .modal-close{background:transparent;border:none;color:var(--text-secondary);cursor:pointer;padding:0.5rem}
        .modal-close:hover{color:var(--danger)}
        .modal-close svg{width:1.25rem;height:1.25rem;fill:currentColor}
        .modal-body{padding:1.25rem}
        .modal-footer{display:flex;gap:0.75rem;padding:1rem 1.25rem;border-top:1px solid var(--border)}
        .modal-footer .btn{flex:1}
        .form-grid{display:grid;gap:1rem}
        .form-grid .full-width{grid-column:1/-1}
        @media(min-width:400px){.form-grid{grid-template-columns:1fr 1fr}}
        .location-btn{width:100%;padding:0.75rem;background:var(--bg-input);border:2px dashed var(--border);border-radius:0.5rem;color:var(--text-secondary);font-family:'Tajawal',sans-serif;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:0.5rem;transition:0.3s}
        .location-btn:hover{border-color:var(--sec-orange);color:var(--sec-orange)}
        .location-btn.active{background:var(--success);border-style:solid;border-color:var(--success);color:#fff}
        .location-btn svg{width:1.25rem;height:1.25rem;fill:currentColor}
        .coords-manual-input{display:flex;gap:0.5rem;align-items:center;margin-top:0.5rem}
        .coords-manual-input input{flex:1;padding:0.6rem 0.75rem;background:var(--bg-input);border:2px solid var(--border);border-radius:0.5rem;color:var(--text-primary);font-family:'Tajawal',monospace;font-size:0.9rem;text-align:center;direction:ltr}
        .coords-manual-input input:focus{border-color:var(--sec-orange);outline:none}
        .coords-manual-input input.valid{border-color:var(--success);background:rgba(92,184,92,0.1)}
        .coords-manual-input .parse-btn{padding:0.6rem 1rem;background:var(--sec-blue-lighter);border:none;border-radius:0.5rem;color:#fff;cursor:pointer;font-family:'Tajawal',sans-serif;font-weight:600}
        .coords-manual-input .parse-btn:hover{background:var(--sec-orange)}
        .coords-hint{font-size:0.7rem;color:var(--text-secondary);margin-top:0.25rem;text-align:center}
        .coords-or{text-align:center;color:var(--text-secondary);font-size:0.8rem;margin:0.5rem 0}
        .fault-inputs{display:grid;grid-template-columns:repeat(3,1fr);gap:0.75rem;margin-bottom:1rem}
        .fault-input{position:relative}
        .fault-input label{position:absolute;top:-0.5rem;right:0.5rem;background:var(--bg-card);padding:0 0.25rem;font-size:0.7rem;color:var(--text-secondary)}
        .fault-input input{width:100%;padding:0.75rem;background:var(--bg-input);border:2px solid var(--border);border-radius:0.5rem;color:var(--text-primary);font-family:'Tajawal',sans-serif;text-align:center}
        .fault-input input:focus{outline:none;border-color:var(--sec-orange)}
        .fault-input input.found{border-color:var(--success);background:rgba(92,184,92,0.1)}
        .fault-input input.not-found{border-color:var(--danger);background:rgba(229,115,115,0.1)}
        .point-label{display:inline-flex;align-items:center;justify-content:center;width:1.5rem;height:1.5rem;background:var(--sec-orange);color:#fff;border-radius:50%;font-weight:700;font-size:0.75rem}
        .status-found{color:var(--success);font-weight:700}
        .status-not-found{color:var(--danger);font-weight:700}
        .fault-actions{display:flex;gap:0.5rem;flex-wrap:wrap;margin-top:1rem}
        .nav-link{display:inline-flex;align-items:center;gap:0.5rem;padding:0.75rem 1.25rem;background:var(--success);color:#fff;text-decoration:none;border-radius:0.5rem;font-weight:600}
        .nav-link:hover{background:#4a9d4a}
        .total-distance{display:flex;align-items:center;gap:0.5rem;padding:0.75rem 1rem;background:var(--bg-input);border-radius:0.5rem;color:var(--sec-orange);font-weight:600}
        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:0.75rem;margin-bottom:1.5rem}
        .stat-card{background:var(--bg-card);border-radius:0.75rem;padding:1rem;text-align:center;border:1px solid var(--border)}
        .stat-card .number{font-size:1.75rem;font-weight:700;color:var(--sec-orange)}
        .stat-card .label{color:var(--text-secondary);font-size:0.8rem}
        .stat-card.online-card{background:linear-gradient(135deg,rgba(92,184,92,0.2),rgba(92,184,92,0.1));border:1px solid rgba(92,184,92,0.5)}
        .stat-card.online-card .number{color:#5cb85c}
        .online-section{border:1px solid rgba(92,184,92,0.3);background:linear-gradient(135deg,rgba(92,184,92,0.05),transparent)}
        .online-section h3{color:#5cb85c}
        .online-section h3 svg{width:1.2rem;height:1.2rem;flex-shrink:0}
        .online-badge{background:#5cb85c;color:#fff;padding:0.2rem 0.6rem;border-radius:1rem;font-size:0.8rem;margin-right:0.5rem}
        .online-users-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:0.5rem;max-height:200px;overflow-y:auto}
        .online-user-card{background:var(--bg-input);border-radius:0.5rem;padding:0.5rem 0.75rem;display:flex;align-items:center;gap:0.5rem;border-right:3px solid #5cb85c}
        .online-user-avatar{width:2rem;height:2rem;background:var(--sec-orange);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.85rem;flex-shrink:0}
        .online-user-info{flex:1;min-width:0}
        .online-user-name{font-weight:600;font-size:0.8rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .online-user-time{font-size:0.65rem;color:var(--text-secondary)}
        .online-indicator{width:8px;height:8px;background:#5cb85c;border-radius:50%;animation:pulse-online 2s infinite;flex-shrink:0}
        @keyframes pulse-online{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.5;transform:scale(1.2)}}
        .empty-online{text-align:center;padding:2rem;color:var(--text-secondary);font-size:0.9rem}
        .admin-section{background:var(--bg-card);border-radius:0.75rem;padding:1.25rem;margin-bottom:1rem}
        .admin-section h3{display:flex;align-items:center;gap:0.5rem;color:var(--sec-orange);margin-bottom:1rem;font-size:1rem}
        .chart-container{height:200px}
        .loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(15,28,46,0.9);display:none;align-items:center;justify-content:center;z-index:2000;flex-direction:column;gap:1rem}
        .loading-overlay.active{display:flex}
        .loading-spinner{width:50px;height:50px;border:4px solid var(--border);border-top-color:var(--sec-orange);border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .first-load-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(30,58,95,0.95);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:3000;gap:1.5rem}
        .first-load-overlay.active{display:flex}
        .first-load-logo{font-size:4rem;animation:pulse 1.5s infinite}
        @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
        .first-load-text{font-size:1.1rem;color:var(--text-primary)}
        .first-load-progress{width:80%;max-width:300px;height:8px;background:var(--bg-input);border-radius:4px;overflow:hidden}
        .first-load-bar{height:100%;background:linear-gradient(135deg,#e8a54b,#d4923a);width:0%;transition:width 0.3s;border-radius:4px}
        .first-load-count{font-size:0.9rem;color:var(--text-secondary)}
        .first-load-done{color:var(--success);font-size:1.2rem;display:none}
        .first-load-done.show{display:block;animation:fadeIn 0.5s}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        .toast-container{position:fixed;bottom:2rem;right:1rem;z-index:3000;display:flex;flex-direction:column;gap:0.5rem}
        .toast{padding:0.75rem 1.25rem;border-radius:0.5rem;color:#fff;font-weight:500;animation:slideIn 0.3s ease;min-width:200px}
        .toast-success{background:var(--success)}
        .toast-error{background:var(--danger)}
        .toast-warning{background:var(--warning);color:#1a1a1a}
        @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
        .install-btn{position:fixed;top:0;left:0;right:0;background:linear-gradient(135deg,#e8a54b,#d4923a);color:#fff;border:none;padding:0.75rem 1rem;font-family:'Tajawal',sans-serif;font-weight:600;cursor:pointer;display:none;align-items:center;justify-content:center;gap:0.5rem;z-index:1000;font-size:0.9rem}
        .install-btn.show{display:flex}
        .install-btn svg{width:1.25rem;height:1.25rem;fill:currentColor}
        .install-btn .close-install{position:absolute;left:1rem;background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer;opacity:0.7}
        .install-btn .close-install:hover{opacity:1}
        body.install-visible .page{padding-top:3rem}
        .password-toggle{position:absolute;left:0.75rem;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--text-secondary);cursor:pointer;padding:0.5rem}
        .password-wrapper{position:relative}
        .password-wrapper input{padding-left:2.5rem}
        .spinner{width:1rem;height:1rem;border:2px solid rgba(255,255,255,0.3);border-top-color:#fff;border-radius:50%;animation:spin 0.8s linear infinite}
    </style>
</head>
<body>
    <div class="page login-page active" id="loginPage">
        <div class="login-card">
            <div class="login-logo"><div class="icon">âš¡</div><h1>Ù†Ø¸Ø§Ù… Ù…Ø­Ø·Ø§Øª SEC</h1><p>Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© Ù„Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡ - Ø¬Ø¯Ø©</p></div>
            <div class="tabs"><div class="tab active" onclick="switchTab('login')">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</div><div class="tab" onclick="switchTab('register')">Ù…Ø´ØªØ±Ùƒ Ø¬Ø¯ÙŠØ¯</div></div>
            <div class="tab-content active" id="loginTab">
                <form onsubmit="return handleLogin(event)">
                    <div class="form-group"><label>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label><input type="tel" id="loginPhone" placeholder="05xxxxxxxx" maxlength="10" oninput="validateLoginPhone()" required><div class="input-hint" id="loginPhoneHint">10 Ø§Ø±Ù‚Ø§Ù… ØªØ¨Ø¯Ø§ Ø¨Ù€ 05</div></div>
                    <button type="submit" class="btn btn-primary" id="loginBtn" disabled>Ø¯Ø®ÙˆÙ„</button>
                </form>
            </div>
            <div class="tab-content" id="registerTab">
                <form onsubmit="return handleRegister(event)">
                    <div class="form-group"><label>Ø§Ù„Ø§Ø³Ù… *</label><input type="text" id="regName" placeholder="Ø§Ù„Ø§Ø³Ù…" oninput="validateRegPhone()" required></div>
                    <div class="form-row">
                        <div class="form-group"><label>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ *</label><input type="tel" id="regPhone" placeholder="05xxxxxxxx" maxlength="10" oninput="validateRegPhone()" required><div class="input-hint" id="regPhoneHint">10 Ø§Ø±Ù‚Ø§Ù…</div></div>
                        <div class="form-group"><label>Ø§Ù„Ù†ÙˆØ¹</label><select id="regType"><option value="Ù…ÙˆØ¸Ù">Ù…ÙˆØ¸Ù</option><option value="Ù…Ù‚Ø§ÙˆÙ„">Ù…Ù‚Ø§ÙˆÙ„</option></select></div>
                    </div>
                    <div class="form-group"><label>Ø§Ù„Ø¨Ø±ÙŠØ¯</label><input type="email" id="regEmail" placeholder="example@email.com"></div>
                    <button type="submit" class="btn btn-success" id="regBtn" disabled>ØªØ³Ø¬ÙŠÙ„</button>
                </form>
            </div>
            <div class="admin-link"><a href="#" onclick="showAdminLogin()">ğŸ” Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙŠØ±</a></div>
        </div>
    </div>

```
<div class="page dashboard-page" id="dashboardPage">
    <header class="header">
        <div class="header-right"><span class="logo">âš¡</span><div><h1>Ù†Ø¸Ø§Ù… Ù…Ø­Ø·Ø§Øª SEC</h1><p>Ø¬Ø¯Ø©</p></div></div>
        <div class="header-left">
            <button class="admin-toggle-btn" id="adminToggleBtn" onclick="goToAdminPage()" style="display:none;">ğŸ” Ø§Ù„Ù…Ø¯ÙŠØ±</button>
            <button class="whatsapp-btn" onclick="openWhatsApp()" title="ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§"><svg viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg></button>
            <div class="cache-status" id="cacheStatus" onclick="manualRefreshCache()"><span>ğŸ“¦</span><span class="cache-text" id="cacheText">...</span></div>
            <div class="user-info"><div class="user-avatar" id="userAvatar">Ù…</div><div><div class="user-name" id="userName">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</div><div class="user-type" id="userType">Ù…ÙˆØ¸Ù</div></div></div>
            <button class="logout-btn" onclick="logout()"><svg viewBox="0 0 24 24"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg><span>Ø®Ø±ÙˆØ¬</span></button>
        </div>
    </header>
    <div class="main-content">
        <section class="search-section">
            <h2><svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø­Ø·Ø©</h2>
            <div class="search-box"><input type="text" id="searchInput" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…Ø­Ø·Ø© Ø§Ùˆ Ø§Ø³Ù… Ù…Ø­Ø·Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„" onkeypress="if(event.key==='Enter')searchStation()"></div>
            <div class="action-buttons">
                <button class="action-btn btn-search" onclick="searchStation()"><svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg><span>Ø¨Ø­Ø«</span></button>
                <button class="action-btn btn-add" onclick="openAddModal('distribution')"><svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg><span>ØªÙˆØ²ÙŠØ¹</span></button>
                <button class="action-btn btn-add-sub" onclick="openAddModal('substation')"><svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg><span>ØªØ­ÙˆÙŠÙ„</span></button>
                <button class="action-btn btn-fault" onclick="openFaultModal()"><svg viewBox="0 0 24 24"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg><span>Ø§Ø¹Ø·Ø§Ù„</span></button>
            </div>
        </section>
        <section class="results-section" id="resultsSection" style="display:none;"><div class="results-header"><h3>Ø§Ù„Ù†ØªØ§Ø¦Ø¬</h3><span class="results-count" id="resultsCount">0</span></div><div id="resultsContent"></div></section>
        <section class="map-section" id="mapSection" style="display:none;"><h3 id="mapTitle">ğŸ“ Ø§Ù„Ù…Ø­Ø·Ø§Øª Ø§Ù„Ù‚Ø±ÙŠØ¨Ø©</h3><div id="nearbyMap" class="map-container"></div><div id="nearbyList" style="margin-top:1rem;"></div></section>
    </div>
</div>

<div class="page dashboard-page" id="adminPage">
    <header class="header">
        <div class="header-right"><span class="logo">âš¡</span><div><h1>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±</h1><p>SEC Ø¬Ø¯Ø©</p></div></div>
        <div class="header-left">
            <button class="back-to-dashboard-btn" onclick="backToEmployee()">ğŸ‘¤ Ù…ÙˆØ¸Ù</button>
            <button class="logout-btn" onclick="adminLogout()"><svg viewBox="0 0 24 24"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg><span>Ø®Ø±ÙˆØ¬</span></button>
        </div>
    </header>
    <div class="main-content">
        <div class="stats-grid">
            <div class="stat-card"><div class="number" id="totalDistribution">0</div><div class="label">ØªÙˆØ²ÙŠØ¹</div></div>
            <div class="stat-card"><div class="number" id="totalSubstations">0</div><div class="label">ØªØ­ÙˆÙŠÙ„</div></div>
            <div class="stat-card"><div class="number" id="totalUsers">0</div><div class="label">Ù…Ø´ØªØ±ÙƒÙŠÙ†</div></div>
            <div class="stat-card"><div class="number" id="totalAdditions">0</div><div class="label">Ø§Ø¶Ø§ÙØ§Øª</div></div>
            <div class="stat-card"><div class="number" id="totalEdits">0</div><div class="label">ØªØ¹Ø¯ÙŠÙ„Ø§Øª</div></div>
            <div class="stat-card online-card"><div class="number" id="onlineCount">0</div><div class="label">ğŸŸ¢ Ù…ØªÙˆØ§Ø¬Ø¯ÙˆÙ†</div></div>
        </div>
        <section class="admin-section online-section"><h3>ğŸŸ¢ Ø§Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙˆÙ† Ø§Ù„Ø§Ù† <span class="online-badge" id="onlineBadge">0</span></h3><div class="online-users-grid" id="onlineUsersList"><div class="empty-online">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØªÙˆØ§Ø¬Ø¯ÙˆÙ† Ø­Ø§Ù„ÙŠØ§</div></div></section>
        <section class="admin-section"><h3>ğŸ“ˆ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</h3><div class="chart-container"><canvas id="visitsChart"></canvas></div></section>
        <section class="admin-section"><h3>ğŸ“Š Ø§Ù„Ù†Ø´Ø§Ø·</h3><div class="chart-container"><canvas id="activityChart"></canvas></div></section>
        <section class="admin-section"><h3>ğŸ‘¥ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</h3><div class="results-table-wrapper"><table class="results-table"><thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¬ÙˆØ§Ù„</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ØªØ³Ø¬ÙŠÙ„</th></tr></thead><tbody id="adminUsersBody"></tbody></table></div></section>
        <section class="admin-section"><h3>ğŸ“‹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</h3><div class="results-table-wrapper"><table class="results-table"><thead><tr><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ø­Ø·Ø©</th><th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr></thead><tbody id="adminLogsBody"></tbody></table></div></section>
    </div>
</div>

<div class="modal-overlay" id="adminLoginModal">
    <div class="modal" style="max-width:350px;">
        <div class="modal-header"><h3>ğŸ” Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙŠØ±</h3><button class="modal-close" onclick="closeModal('adminLoginModal')"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg></button></div>
        <div class="modal-body"><div class="form-group"><label>Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„</label><div class="password-wrapper"><input type="password" id="adminCode" placeholder="****"><button type="button" class="password-toggle" onclick="togglePassword()">ğŸ‘</button></div></div></div>
        <div class="modal-footer"><button class="btn btn-primary" onclick="adminLogin()">Ø¯Ø®ÙˆÙ„</button></div>
    </div>
</div>

<div class="modal-overlay" id="addDistributionModal">
    <div class="modal">
        <div class="modal-header"><h3><svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>Ø§Ø¶Ø§ÙØ© Ù…Ø­Ø·Ø© ØªÙˆØ²ÙŠØ¹</h3><button class="modal-close" onclick="closeModal('addDistributionModal')"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg></button></div>
        <div class="modal-body">
            <div class="form-grid">
                <div class="form-group"><label>Ø±Ù‚Ù… Ø§Ù„Ù…Ø­Ø·Ø© *</label><input type="text" id="addDistNumber" required></div>
                <div class="form-group"><label>Ø§Ù„Ù…ØºØ°ÙŠ</label><input type="text" id="addDistFeeder"></div>
                <div class="form-group full-width"><label>Ø§Ù„Ø­ÙŠ *</label><input type="text" id="addDistRegion" required></div>
                <div class="form-group"><label>Ø®Ø· Ø§Ù„Ø¹Ø±Ø¶</label><input type="text" id="addDistLat" readonly></div>
                <div class="form-group"><label>Ø®Ø· Ø§Ù„Ø·ÙˆÙ„</label><input type="text" id="addDistLng" readonly></div>
                <div class="form-group full-width">
                    <button type="button" class="location-btn" id="addDistLocationBtn" onclick="getCurrentLocation('addDist')"><svg viewBox="0 0 24 24"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4z"/></svg><span>ğŸ“ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ (GPS)</span></button>
                    <div class="coords-or">- Ø§Ùˆ Ø§Ø¯Ø®Ù„ ÙŠØ¯ÙˆÙŠØ§ -</div>
                    <div class="coords-manual-input"><input type="text" id="addDistCoordsManual" placeholder="21.5234,39.1876" dir="ltr"><button type="button" class="parse-btn" onclick="parseManualCoords('addDist')">ØªØ·Ø¨ÙŠÙ‚</button></div>
                    <div class="coords-hint">Ø§Ù„ØµÙŠØºØ©: Ø®Ø· Ø§Ù„Ø¹Ø±Ø¶,Ø®Ø· Ø§Ù„Ø·ÙˆÙ„</div>
                </div>
                <div class="form-group full-width"><label>Ø§Ù„Ø³Ø¨Ø¨</label><textarea id="addDistReason" rows="2"></textarea></div>
            </div>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('addDistributionModal')">Ø§Ù„ØºØ§Ø¡</button><button class="btn btn-success" onclick="submitAddDistribution()">Ø§Ø¶Ø§ÙØ©</button></div>
    </div>
</div>

<div class="modal-overlay" id="addSubstationModal">
    <div class="modal">
        <div class="modal-header"><h3><svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>Ø§Ø¶Ø§ÙØ© Ù…Ø­Ø·Ø© ØªØ­ÙˆÙŠÙ„</h3><button class="modal-close" onclick="closeModal('addSubstationModal')"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg></button></div>
        <div class="modal-body">
            <div class="form-grid">
                <div class="form-group full-width"><label>Ø§Ø®ØªØµØ§Ø± Ø§Ù„Ù…Ø­Ø·Ø© *</label><input type="text" id="addSubShortName" placeholder="Ù…Ø«Ø§Ù„: MDN 2" required></div>
                <div class="form-group"><label>Ø®Ø· Ø§Ù„Ø¹Ø±Ø¶</label><input type="text" id="addSubLat" readonly></div>
                <div class="form-group"><label>Ø®Ø· Ø§Ù„Ø·ÙˆÙ„</label><input type="text" id="addSubLng" readonly></div>
                <div class="form-group full-width">
                    <button type="button" class="location-btn" id="addSubLocationBtn" onclick="getCurrentLocation('addSub')"><svg viewBox="0 0 24 24"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4z"/></svg><span>ğŸ“ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ (GPS)</span></button>
                    <div class="coords-or">- Ø§Ùˆ Ø§Ø¯Ø®Ù„ ÙŠØ¯ÙˆÙŠØ§ -</div>
                    <div class="coords-manual-input"><input type="text" id="addSubCoordsManual" placeholder="21.5234,39.1876" dir="ltr"><button type="button" class="parse-btn" onclick="parseManualCoords('addSub')">ØªØ·Ø¨ÙŠÙ‚</button></div>
                </div>
                <div class="form-group full-width"><label>Ø§Ù„Ø³Ø¨Ø¨</label><textarea id="addSubReason" rows="2"></textarea></div>
            </div>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('addSubstationModal')">Ø§Ù„ØºØ§Ø¡</button><button class="btn btn-success" onclick="submitAddSubstation()">Ø§Ø¶Ø§ÙØ©</button></div>
    </div>
</div>

<div class="modal-overlay" id="editModal">
    <div class="modal">
        <div class="modal-header"><h3><svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z"/></svg>ØªØ¹Ø¯ÙŠÙ„ Ù…Ø­Ø·Ø©</h3><button class="modal-close" onclick="closeModal('editModal')"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg></button></div>
        <div class="modal-body">
            <div class="form-grid">
                <div class="form-group full-width"><label>Ø±Ù‚Ù… Ø§Ù„Ù…Ø­Ø·Ø©</label><input type="text" id="editStationNumber" readonly style="background:var(--bg-dark);cursor:not-allowed;opacity:0.7;"><div class="input-hint">ğŸ”’ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ù‚Ù…</div></div>
                <div class="form-group" id="editFeederGroup"><label>Ø§Ù„Ù…ØºØ°ÙŠ</label><input type="text" id="editFeeder"></div>
                <div class="form-group" id="editRegionGroup"><label>Ø§Ù„Ø­ÙŠ</label><input type="text" id="editRegion"></div>
                <div class="form-group"><label>Ø®Ø· Ø§Ù„Ø¹Ø±Ø¶</label><input type="text" id="editLatitude"></div>
                <div class="form-group"><label>Ø®Ø· Ø§Ù„Ø·ÙˆÙ„</label><input type="text" id="editLongitude"></div>
                <div class="form-group full-width">
                    <button type="button" class="location-btn" id="editLocationBtn" onclick="getCurrentLocation('edit')"><svg viewBox="0 0 24 24"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4z"/></svg><span>ğŸ“ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ (GPS)</span></button>
                    <div class="coords-or">- Ø§Ùˆ Ø§Ø¯Ø®Ù„ ÙŠØ¯ÙˆÙŠØ§ -</div>
                    <div class="coords-manual-input"><input type="text" id="editCoordsManual" placeholder="21.5234,39.1876" dir="ltr"><button type="button" class="parse-btn" onclick="parseManualCoords('edit')">ØªØ·Ø¨ÙŠÙ‚</button></div>
                </div>
                <div class="form-group full-width"><label>Ø§Ù„Ø³Ø¨Ø¨</label><textarea id="editReason"></textarea></div>
            </div>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('editModal')">Ø§Ù„ØºØ§Ø¡</button><button class="btn btn-warning" onclick="submitEdit()">Ø­ÙØ¸</button></div>
    </div>
</div>

<div class="modal-overlay" id="faultModal">
    <div class="modal" style="max-width:600px;">
        <div class="modal-header"><h3><svg viewBox="0 0 24 24"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>ØªØªØ¨Ø¹ Ø§Ù„Ø§Ø¹Ø·Ø§Ù„</h3><button class="modal-close" onclick="closeModal('faultModal')"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg></button></div>
        <div class="modal-body">
            <div class="fault-inputs">
                <div class="fault-input"><label>1</label><input type="text" id="fault1" placeholder="Ù…Ø­Ø·Ø© 1"></div>
                <div class="fault-input"><label>2</label><input type="text" id="fault2" placeholder="Ù…Ø­Ø·Ø© 2"></div>
                <div class="fault-input"><label>3</label><input type="text" id="fault3" placeholder="Ù…Ø­Ø·Ø© 3"></div>
                <div class="fault-input"><label>4</label><input type="text" id="fault4" placeholder="Ù…Ø­Ø·Ø© 4"></div>
                <div class="fault-input"><label>5</label><input type="text" id="fault5" placeholder="Ù…Ø­Ø·Ø© 5"></div>
                <div class="fault-input"><label>6</label><input type="text" id="fault6" placeholder="Ù…Ø­Ø·Ø© 6"></div>
            </div>
            <button class="btn btn-danger" onclick="searchFaultStations()" style="margin-bottom:1rem;">ğŸ” Ø¨Ø­Ø« ÙˆØªØªØ¨Ø¹</button>
            <div id="faultResults" style="display:none;">
                <div class="results-header"><h3>Ø§Ù„Ù†ØªØ§Ø¦Ø¬</h3><span class="results-count" id="faultCount">0</span></div>
                <div class="results-table-wrapper"><table class="results-table"><thead><tr><th>Ø§Ù„Ù†Ù‚Ø·Ø©</th><th>Ø§Ù„Ù…Ø­Ø·Ø©</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead><tbody id="faultTableBody"></tbody></table></div>
                <div id="faultMapContainer" class="map-container" style="height:250px;margin-top:1rem;border-radius:0.5rem;"></div>
                <div class="fault-actions" id="faultActions"></div>
            </div>
        </div>
    </div>
</div>

<div class="loading-overlay" id="loadingOverlay"><div class="loading-spinner"></div><div>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div></div>
<div class="toast-container" id="toastContainer"></div>
<div class="first-load-overlay" id="firstLoadOverlay">
    <div class="first-load-logo">âš¡</div>
    <div class="first-load-text">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
    <div class="first-load-progress"><div class="first-load-bar" id="firstLoadBar"></div></div>
    <div class="first-load-count" id="firstLoadCount">0%</div>
    <div class="first-load-done" id="firstLoadDone">âœ“ ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„!</div>
</div>
<div class="install-btn" id="installBtn"><button class="close-install" onclick="hideInstallBanner(event)">Ã—</button><svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg><span onclick="installApp()">ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</span></div>

<script>
    const API_URL = â€'https://script.google.com/macros/s/AKfycbyf3resa2MMyskllbjrr7L2K922QOBqi11c5hpJuOytT0jZZ-8MRtUufxKlXO1JUj7diw/exec';
    let currentUser = null, nearbyMap = null, faultMap = null, faultStations = [], editingStationType = null, deferredPrompt = null;
    let isAdmin = false;
    const CACHE_KEY = 'sec_stations_v8', CACHE_VERSION_KEY = 'sec_version_v8';
    let allStations = [], isStationsLoaded = false, currentVersion = null;
    let onlineUpdateTimer = null, contactPhone = '966500000000';
    let currentSearchedStation = null, showFeederMode = false;

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
    function isOnline() { return navigator.onLine; }
    
    // Ø¶ØºØ· ÙˆÙÙƒ Ø¶ØºØ· Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    function compressData(data) { return LZString.compress(JSON.stringify(data)); }
    function decompressData(data) { 
        try { 
            var decompressed = LZString.decompress(data);
            return decompressed ? JSON.parse(decompressed) : null; 
        } catch(e) { return null; } 
    }
    
    // Ø­ÙØ¸ Ø§Ù„ÙƒØ§Ø´ Ù…Ø¹ Ø§Ù„Ø¶ØºØ·
    function saveToCache(stations) {
        try {
            var compressed = compressData(stations);
            localStorage.setItem(CACHE_KEY, compressed);
            console.log('Cache saved: ' + (compressed.length / 1024).toFixed(1) + ' KB (compressed)');
            return true;
        } catch(e) {
            console.warn('Cache save failed:', e);
            return false;
        }
    }
    
    // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ÙƒØ§Ø´ Ù…Ø¹ ÙÙƒ Ø§Ù„Ø¶ØºØ·
    function loadFromCache() {
        try {
            var compressed = localStorage.getItem(CACHE_KEY);
            if (!compressed) return null;
            return decompressData(compressed);
        } catch(e) { return null; }
    }
    
    async function loadStationsCache() { 
        updateCacheStatus('loading', 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...'); 
        // Ù…Ø³Ø­ Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ù‚Ø¯ÙŠÙ… (Ø§Ù„Ø¥ØµØ¯Ø§Ø± 7 ØºÙŠØ± Ø§Ù„Ù…Ø¶ØºÙˆØ·)
        try {
            localStorage.removeItem('sec_stations_v7');
            localStorage.removeItem('sec_version_v7');
        } catch(e) {}
        
        currentVersion = localStorage.getItem(CACHE_VERSION_KEY); 
        var cached = loadFromCache();
        if (cached && cached.length > 0 && currentVersion) { 
            allStations = cached; 
            isStationsLoaded = true; 
            updateCacheStatus('loaded', allStations.length + ' Ù…Ø­Ø·Ø©'); 
            return; 
        } 
        await refreshStationsCacheWithProgress(); 
    }
    
    async function refreshStationsCacheWithProgress() {
        const overlay = document.getElementById('firstLoadOverlay');
        const bar = document.getElementById('firstLoadBar');
        const countEl = document.getElementById('firstLoadCount');
        const doneEl = document.getElementById('firstLoadDone');
        overlay.classList.add('active');
        bar.style.width = '10%';
        countEl.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...';
        
        if (!isOnline()) {
            bar.style.width = '100%';
            bar.style.background = 'var(--danger)';
            countEl.textContent = 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª';
            setTimeout(function() { overlay.classList.remove('active'); }, 2000);
            return;
        }
        
        try {
            bar.style.width = '30%';
            countEl.textContent = 'Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...';
            const versionResult = await apiGet('getVersion');
            const stationsResult = await apiGet('getAllStations');
            bar.style.width = '70%';
            if (stationsResult.error) {
                throw new Error(stationsResult.error);
            }
            if (stationsResult.stations && stationsResult.stations.length > 0) {
                allStations = stationsResult.stations;
                isStationsLoaded = true;
                currentVersion = versionResult.version || Date.now().toString();
                bar.style.width = '90%';
                countEl.textContent = 'Ø¬Ø§Ø±ÙŠ Ø¶ØºØ· Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...';
                // Ø­ÙØ¸ Ù…Ø¹ Ø§Ù„Ø¶ØºØ·
                saveToCache(allStations);
                localStorage.setItem(CACHE_VERSION_KEY, currentVersion);
                bar.style.width = '100%';
                countEl.textContent = allStations.length + ' Ù…Ø­Ø·Ø©';
                doneEl.classList.add('show');
                updateCacheStatus('loaded', allStations.length + ' Ù…Ø­Ø·Ø©');
                setTimeout(function() { overlay.classList.remove('active'); showToast('ØªÙ… ØªØ­Ù…ÙŠÙ„ ' + allStations.length + ' Ù…Ø­Ø·Ø©'); }, 1500);
            } else { 
                countEl.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª';
                updateCacheStatus('error', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª');
                console.log('No stations found. Check sheet names in Apps Script.');
                setTimeout(function() { overlay.classList.remove('active'); }, 3000);
            }
        } catch (e) {
            console.error('Load Error:', e);
            bar.style.width = '100%';
            bar.style.background = 'var(--danger)';
            countEl.textContent = 'Ø®Ø·Ø§: ' + (e.message || 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„');
            updateCacheStatus('error', 'Ø®Ø·Ø§ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
            setTimeout(function() { overlay.classList.remove('active'); showToast('Ø®Ø·Ø§: ' + e.message, 'error'); }, 3000);
        }
    }
    
    async function refreshStationsCache() { 
        if (!isOnline()) {
            updateCacheStatus('error', 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„');
            showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª', 'error');
            return;
        }
        try { 
            updateCacheStatus('loading', 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...'); 
            const [v, s] = await Promise.all([apiGet('getVersion'), apiGet('getAllStations')]); 
            if (s.stations && s.stations.length) { 
                allStations = s.stations; 
                isStationsLoaded = true; 
                currentVersion = v.version || Date.now().toString(); 
                saveToCache(allStations);
                localStorage.setItem(CACHE_VERSION_KEY, currentVersion);
                updateCacheStatus('loaded', allStations.length + ' Ù…Ø­Ø·Ø©'); 
            } else { updateCacheStatus('error', 'Ø®Ø·Ø§'); }
        } catch (e) { updateCacheStatus('error', 'Ø®Ø·Ø§ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„'); } 
    }
    
    function clearStationsCache() { localStorage.removeItem(CACHE_KEY); localStorage.removeItem(CACHE_VERSION_KEY); isStationsLoaded = false; allStations = []; currentVersion = null; }
    async function manualRefreshCache() { 
        if (!isOnline()) { 
            showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª', 'error'); 
            return; 
        }
        clearStationsCache(); 
        await refreshStationsCache(); 
        showToast('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«'); 
    }
    function updateCacheStatus(s, t) { var el = document.getElementById('cacheStatus'), txt = document.getElementById('cacheText'); if (el && txt) { el.className = 'cache-status ' + s; txt.textContent = t; } }
    
    function searchStationLocal(n) { 
        if (!n) return { found: false }; 
        var searchValue = String(n).trim().toUpperCase();
        var station = allStations.find(function(x) { return String(x.number).toUpperCase() === searchValue; });
        if (station) return { found: true, station: station };
        var cleaned = searchValue.replace(/[^a-zA-Z0-9]/g, '');
        if (cleaned) {
            station = allStations.find(function(x) {
                if (x.type === 'substation') {
                    var num = String(x.number).replace(/[^a-zA-Z0-9]/g, '').toUpperCase();
                    return num === cleaned;
                }
                return false;
            });
        }
        return station ? { found: true, station: station } : { found: false }; 
    }
    
    function getNearbyStationsLocal(lat, lng, r) { 
        r = r || 1.5;
        if (!lat || !lng) return []; 
        var cLat = parseFloat(lat), cLng = parseFloat(lng); 
        return allStations.filter(function(s) { 
            if (!s.lat || !s.lng) return false; 
            var d = calcDistance(cLat, cLng, parseFloat(s.lat), parseFloat(s.lng)); 
            s.distance = d.toFixed(2); 
            return d <= r; 
        }).sort(function(a, b) { return parseFloat(a.distance) - parseFloat(b.distance); }); 
    }
    
    function calcDistance(lat1, lon1, lat2, lon2) { var R = 6371, dLat = (lat2 - lat1) * Math.PI / 180, dLon = (lon2 - lon1) * Math.PI / 180, a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2)*Math.sin(dLon/2); return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); }

    function showLoading() { document.getElementById('loadingOverlay').classList.add('active'); }
    function hideLoading() { document.getElementById('loadingOverlay').classList.remove('active'); }
    
    async function apiGet(action, params) { 
        params = params || {};
        try { 
            var url = new URL(API_URL); 
            url.searchParams.append('action', action); 
            Object.keys(params).forEach(function(k) { url.searchParams.append(k, params[k]); }); 
            var response = await fetch(url);
            return await response.json(); 
        } catch (e) { 
            return { error: 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„' }; 
        } 
    }
    
    async function apiPost(data) { 
        try { 
            var response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(data) });
            return await response.json(); 
        } catch (e) { 
            return { error: 'ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ Ø¨Ø³Ø¨Ø¨ Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„', connectionError: true }; 
        } 
    }
    
    function showPage(id) { 
        console.log('Switching to page:', id);
        var pages = document.querySelectorAll('.page');
        for (var i = 0; i < pages.length; i++) {
            pages[i].classList.remove('active');
            pages[i].style.display = 'none';
        }
        var targetPage = document.getElementById(id);
        if (targetPage) {
            targetPage.classList.add('active');
            targetPage.style.display = 'block';
        }
    }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    function showToast(msg, type) { type = type || 'success'; var c = document.getElementById('toastContainer'), t = document.createElement('div'); t.className = 'toast toast-' + type; t.innerHTML = msg; c.appendChild(t); setTimeout(function() { t.style.opacity = '0'; setTimeout(function() { t.remove(); }, 300); }, 3000); }
    function togglePassword() { var i = document.getElementById('adminCode'); i.type = i.type === 'password' ? 'text' : 'password'; }
    
    async function loadContactPhone() { try { var r = await apiGet('getContactNumber'); if (r.phone) contactPhone = r.phone; } catch (e) {} }
    function openWhatsApp() { var phone = contactPhone.replace(/\D/g, ''); if (phone.startsWith('0')) phone = '966' + phone.substring(1); if (!phone.startsWith('966')) phone = '966' + phone; window.open('https://wa.me/' + phone + '?text=' + encodeURIComponent('Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ…'), '_blank'); }

    function startOnlineTracking() { if (!currentUser) return; updateMyOnlineStatus(); if (onlineUpdateTimer) clearInterval(onlineUpdateTimer); onlineUpdateTimer = setInterval(updateMyOnlineStatus, 30000); }
    function stopOnlineTracking() { if (onlineUpdateTimer) { clearInterval(onlineUpdateTimer); onlineUpdateTimer = null; } setMeOffline(); }
    async function updateMyOnlineStatus() { if (!currentUser) return; try { await apiPost({ action: 'updateOnline', phone: currentUser.phone, name: currentUser.name }); } catch (e) {} }
    function setMeOffline() { if (currentUser) { try { navigator.sendBeacon && navigator.sendBeacon(API_URL, JSON.stringify({ action: 'userOffline', phone: currentUser.phone })); } catch (e) {} } }
    window.addEventListener('beforeunload', setMeOffline);

    function normalizePhone(p) { if (!p) return ''; var c = String(p).replace(/\D/g, ''); if (c.startsWith('966') && c.length === 12) c = '0' + c.substring(3); if (c.startsWith('5') && c.length === 9) c = '0' + c; return c; }
    function isValidPhone(p) { var n = normalizePhone(p); return n.length === 10 && n.startsWith('05'); }
    function validateLoginPhone() { var i = document.getElementById('loginPhone'), h = document.getElementById('loginPhoneHint'), b = document.getElementById('loginBtn'); i.value = i.value.replace(/\D/g, ''); var n = normalizePhone(i.value); if (!i.value.length) { i.className = ''; h.textContent = '10 Ø§Ø±Ù‚Ø§Ù… ØªØ¨Ø¯Ø§ Ø¨Ù€ 05'; h.className = 'input-hint'; b.disabled = true; } else if (isValidPhone(i.value)) { i.className = 'valid'; h.textContent = 'âœ“'; h.className = 'input-hint success'; b.disabled = false; } else { i.className = 'error'; h.textContent = n.length < 10 ? (10-n.length) + ' Ø§Ø±Ù‚Ø§Ù…' : 'ÙŠØ¬Ø¨ 05'; h.className = 'input-hint error'; b.disabled = true; } }
    function validateRegPhone() { var i = document.getElementById('regPhone'), h = document.getElementById('regPhoneHint'), b = document.getElementById('regBtn'), name = document.getElementById('regName').value.trim(); i.value = i.value.replace(/\D/g, ''); var valid = isValidPhone(i.value) && name.length > 0; if (!i.value.length) { i.className = ''; h.textContent = '10 Ø§Ø±Ù‚Ø§Ù…'; h.className = 'input-hint'; } else if (isValidPhone(i.value)) { i.className = 'valid'; h.textContent = 'âœ“'; h.className = 'input-hint success'; } else { i.className = 'error'; h.className = 'input-hint error'; } b.disabled = !valid; }

    function switchTab(t) { document.querySelectorAll('.tab').forEach(function(x) { x.classList.remove('active'); }); document.querySelectorAll('.tab-content').forEach(function(x) { x.classList.remove('active'); }); if (t === 'login') { document.querySelector('.tab:first-child').classList.add('active'); document.getElementById('loginTab').classList.add('active'); } else { document.querySelector('.tab:last-child').classList.add('active'); document.getElementById('registerTab').classList.add('active'); } }
    
    async function handleLogin(e) { 
        e.preventDefault(); 
        if (!isValidPhone(document.getElementById('loginPhone').value)) { showToast('Ø±Ù‚Ù… Ø®Ø§Ø·Ø¦', 'error'); return false; } 
        var p = normalizePhone(document.getElementById('loginPhone').value); 
        showLoading(); 
        try {
            var r = await apiPost({ action: 'loginUser', phone: p }); 
            hideLoading(); 
            if (r.notFound) { showToast('ØºÙŠØ± Ù…Ø³Ø¬Ù„', 'warning'); switchTab('register'); document.getElementById('regPhone').value = p; validateRegPhone(); return false; } 
            if (r.error) { showToast(r.error, 'error'); return false; } 
            currentUser = r.user; 
            localStorage.setItem('currentUser', JSON.stringify(currentUser)); 
            updateUserUI(); 
            showPage('dashboardPage'); 
            showToast('Ù…Ø±Ø­Ø¨Ø§ ' + currentUser.name); 
            loadStationsCache(); 
            startOnlineTracking(); 
        } catch (err) { hideLoading(); showToast('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„', 'error'); }
        return false; 
    }
    
    async function handleRegister(e) { 
        e.preventDefault(); 
        var name = document.getElementById('regName').value.trim(); 
        if (!name || !isValidPhone(document.getElementById('regPhone').value)) { showToast('ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error'); return false; } 
        var p = normalizePhone(document.getElementById('regPhone').value); 
        showLoading(); 
        try {
            var r = await apiPost({ action: 'registerUser', name: name, phone: p, email: document.getElementById('regEmail').value.trim(), userType: document.getElementById('regType').value }); 
            hideLoading(); 
            if (r.error && !r.alreadyExists) { showToast(r.error, 'error'); return false; } 
            currentUser = r.user; 
            localStorage.setItem('currentUser', JSON.stringify(currentUser)); 
            updateUserUI(); 
            showPage('dashboardPage'); 
            showToast(r.alreadyExists ? 'Ù…Ø±Ø­Ø¨Ø§ Ø¨Ø¹ÙˆØ¯ØªÙƒ' : 'ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„'); 
            loadStationsCache(); 
            startOnlineTracking(); 
        } catch (err) { hideLoading(); showToast('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„', 'error'); }
        return false; 
    }
    
    function updateUserUI() { document.getElementById('userName').textContent = currentUser.name; document.getElementById('userAvatar').textContent = currentUser.name.charAt(0); document.getElementById('userType').textContent = currentUser.type || 'Ù…ÙˆØ¸Ù'; }
    function showAdminLogin() { document.getElementById('adminLoginModal').classList.add('active'); }
    async function adminLogin() { 
        var c = document.getElementById('adminCode').value; 
        showLoading(); 
        var r = await apiGet('getAdminCode'); 
        hideLoading(); 
        if (r.code && c === r.code) { 
            isAdmin = true;
            localStorage.setItem('isAdmin', 'true');
            document.getElementById('adminToggleBtn').style.display = 'flex';
            closeModal('adminLoginModal'); 
            showPage('adminPage'); 
            loadAdminData();
            showToast('Ù…Ø±Ø­Ø¨Ø§ Ø¨Ùƒ ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±');
        } else { 
            showToast('Ø±Ù…Ø² Ø®Ø§Ø·Ø¦', 'error'); 
        } 
    }
    function goToAdminPage() {
        if (isAdmin) {
            showPage('adminPage');
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¨Ø¯ÙˆÙ† Ø§Ù†ØªØ¸Ø§Ø±
            loadAdminData();
        }
    }
    function backToEmployee() {
        showPage('dashboardPage');
    }
    function adminLogout() {
        isAdmin = false;
        localStorage.removeItem('isAdmin');
        document.getElementById('adminToggleBtn').style.display = 'none';
        logout();
    }
    function checkAdminStatus() {
        if (localStorage.getItem('isAdmin') === 'true') {
            isAdmin = true;
            document.getElementById('adminToggleBtn').style.display = 'flex';
        }
    }
    function logout() { stopOnlineTracking(); currentUser = null; isAdmin = false; localStorage.removeItem('currentUser'); localStorage.removeItem('isAdmin'); document.getElementById('adminToggleBtn').style.display = 'none'; showPage('loginPage'); document.getElementById('loginPhone').value = ''; document.getElementById('loginBtn').disabled = true; showToast('ØªÙ… Ø§Ù„Ø®Ø±ÙˆØ¬'); }
    function checkSession() { var s = localStorage.getItem('currentUser'); if (s) { currentUser = JSON.parse(s); updateUserUI(); showPage('dashboardPage'); loadStationsCache(); startOnlineTracking(); checkAdminStatus(); } }

    async function searchStation() { 
        var v = document.getElementById('searchInput').value.trim(); 
        if (!v) { showToast('Ø§Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù…', 'warning'); return; } 
        if (!isStationsLoaded) { showLoading(); await loadStationsCache(); hideLoading(); } 
        var r = searchStationLocal(v), rc = document.getElementById('resultsContent'), rn = document.getElementById('resultsCount'); 
        document.getElementById('resultsSection').style.display = 'block';
        showFeederMode = false; 
        if (!r.found) { 
            rc.innerHTML = '<div class="not-found-card"><h4>ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</h4><div class="searched-number">' + v + '</div></div>'; 
            rn.textContent = '0'; 
            document.getElementById('mapSection').style.display = 'none'; 
            currentSearchedStation = null; 
        } else { 
            currentSearchedStation = r.station; 
            var s = r.station;
            var url = s.googleMap || (s.lat && s.lng ? 'https://www.google.com/maps?q=' + s.lat + ',' + s.lng : '');
            var tb = s.type === 'distribution' ? '<span class="type-badge type-distribution">ØªÙˆØ²ÙŠØ¹</span>' : '<span class="type-badge type-substation">ØªØ­ÙˆÙŠÙ„</span>'; 
            var editBtn = '<button class="action-btn btn-edit" style="padding:0.4rem 0.8rem;font-size:0.8rem;" onclick="openEditFromSearch()"><svg viewBox="0 0 24 24" style="width:1rem;height:1rem;"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg><span>ØªØ¹Ø¯ÙŠÙ„</span></button>';
            var feederBtn = ''; 
            if (s.type === 'distribution' && s.feeder) { 
                feederBtn = '<div class="feeder-toggle"><button class="feeder-btn active" id="nearbyBtn" onclick="toggleMapMode(\'nearby\')"><svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/></svg>Ø§Ù„Ù‚Ø±ÙŠØ¨Ø© (1.5 ÙƒÙ…)</button><button class="feeder-btn" id="feederBtn" onclick="toggleMapMode(\'feeder\')"><svg viewBox="0 0 24 24"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg>Ù…Ø­Ø·Ø§Øª Ø§Ù„Ù…ØºØ°ÙŠ (' + s.feeder + ')</button></div>'; 
            } 
            var ex = s.type === 'distribution' ? '<tr><td colspan="4"><strong>Ø§Ù„Ù…ØºØ°ÙŠ:</strong> ' + (s.feeder||'-') + ' | <strong>Ø§Ù„Ø­ÙŠ:</strong> ' + (s.region||'-') + '</td></tr>' : ''; 
            rc.innerHTML = '<div class="results-table-wrapper"><table class="results-table"><thead><tr><th>Ø§Ù„Ù…Ø­Ø·Ø©</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ø®Ø±ÙŠØ·Ø©</th><th>Ø§Ø¬Ø±Ø§Ø¡</th></tr></thead><tbody><tr><td><strong>' + s.number + '</strong></td><td>' + tb + '</td><td>' + (url ? '<a href="' + url + '" target="_blank" class="map-link"><svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/></svg>ÙØªØ­</a>' : '-') + '</td><td>' + editBtn + '</td></tr>' + ex + '</tbody></table></div>' + feederBtn; 
            rn.textContent = '1'; 
            if (s.lat && s.lng) { toggleMapMode('nearby'); } else { document.getElementById('mapSection').style.display = 'none'; } 
        } 
    }
    
    function openEditFromSearch() {
        if (!currentSearchedStation) { showToast('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ±', 'error'); return; }
        var s = currentSearchedStation;
        editingStationType = s.type;
        document.getElementById('editStationNumber').value = s.number;
        if (s.type === 'distribution') {
            document.getElementById('editFeeder').value = s.feeder || '';
            document.getElementById('editRegion').value = s.region || '';
            document.getElementById('editFeederGroup').style.display = '';
            document.getElementById('editRegionGroup').style.display = '';
        } else {
            document.getElementById('editFeederGroup').style.display = 'none';
            document.getElementById('editRegionGroup').style.display = 'none';
        }
        document.getElementById('editLatitude').value = s.lat || '';
        document.getElementById('editLongitude').value = s.lng || '';
        document.getElementById('editReason').value = '';
        document.getElementById('editCoordsManual').value = '';
        document.getElementById('editLocationBtn').classList.remove('active');
        document.getElementById('editModal').classList.add('active');
    }
    
    function toggleMapMode(mode) {
        showFeederMode = (mode === 'feeder');
        var nearbyBtn = document.getElementById('nearbyBtn');
        var feederBtn = document.getElementById('feederBtn');
        if (nearbyBtn) nearbyBtn.classList.toggle('active', !showFeederMode);
        if (feederBtn) feederBtn.classList.toggle('active', showFeederMode);
        if (showFeederMode) { loadFeederStations(currentSearchedStation); } 
        else { loadNearbyStationsLocal(currentSearchedStation); }
    }
    
    function loadNearbyStationsLocal(station) {
        if (!station || !station.lat || !station.lng) return;
        document.getElementById('mapSection').style.display = 'block';
        document.getElementById('mapTitle').innerHTML = 'ğŸ“ Ø§Ù„Ù…Ø­Ø·Ø§Øª Ø§Ù„Ù‚Ø±ÙŠØ¨Ø© (1.5 ÙƒÙ…)';
        var nearby = getNearbyStationsLocal(station.lat, station.lng, 1.5);
        renderNearbyMap(station, nearby);
    }
    
    function loadFeederStations(station) {
        if (!station || station.type !== 'distribution' || !station.feeder) return;
        document.getElementById('mapSection').style.display = 'block';
        document.getElementById('mapTitle').innerHTML = 'ğŸ”Œ Ù…Ø­Ø·Ø§Øª Ø§Ù„Ù…ØºØ°ÙŠ (' + station.feeder + ')';
        var feederStations = allStations.filter(function(s) { return s.type === 'distribution' && s.feeder === station.feeder && s.number !== station.number && s.lat && s.lng; });
        feederStations.forEach(function(s) { s.distance = calcDistance(parseFloat(station.lat), parseFloat(station.lng), parseFloat(s.lat), parseFloat(s.lng)).toFixed(2); });
        feederStations.sort(function(a, b) { return parseFloat(a.distance) - parseFloat(b.distance); });
        renderFeederMap(station, feederStations);
    }
    
    function renderNearbyMap(center, stations) {
        var mapDiv = document.getElementById('nearbyMap');
        if (nearbyMap) { nearbyMap.remove(); nearbyMap = null; }
        nearbyMap = L.map(mapDiv).setView([parseFloat(center.lat), parseFloat(center.lng)], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(nearbyMap);
        // Ø§Ù„Ù…Ø­Ø·Ø© Ø§Ù„Ù…Ø¨Ø­ÙˆØ«Ø© - Ø¯Ø¨ÙˆØ³ Ø¨Ø§Ø±Ø²
        var centerIcon = L.divIcon({ className: 'custom-marker', html: '<div style="font-size:28px;text-shadow:2px 2px 4px rgba(0,0,0,0.5);">ğŸ“</div>', iconSize: [28, 28], iconAnchor: [14, 28] });
        L.marker([parseFloat(center.lat), parseFloat(center.lng)], { icon: centerIcon }).addTo(nearbyMap).bindPopup('<b style="color:#e8a54b;font-size:1.1rem;">' + center.number + '</b><br>ğŸ¯ Ø§Ù„Ù…Ø­Ø·Ø© Ø§Ù„Ù…Ø¨Ø­ÙˆØ«Ø©').openPopup();
        var bounds = [[parseFloat(center.lat), parseFloat(center.lng)]];
        stations.forEach(function(s) {
            if (s.number === center.number) return;
            // Ù…Ø­Ø·Ø§Øª Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨Ù„ÙˆÙ† Ø¨Ù†ÙØ³Ø¬ÙŠ Ø¨Ø§Ø±Ø²ØŒ Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø¨Ù„ÙˆÙ† Ø£Ø®Ø¶Ø±
            var color = s.type === 'substation' ? '#9b59b6' : '#27ae60';
            var size = s.type === 'substation' ? 18 : 12;
            var icon = L.divIcon({ className: 'custom-marker', html: '<div style="background:' + color + ';width:' + size + 'px;height:' + size + 'px;border-radius:50%;border:2px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.3);"></div>', iconSize: [size, size], iconAnchor: [size/2, size/2] });
            L.marker([parseFloat(s.lat), parseFloat(s.lng)], { icon: icon }).addTo(nearbyMap).bindPopup('<b>' + s.number + '</b><br>ğŸ“ ' + s.distance + ' ÙƒÙ…<br>' + (s.type === 'substation' ? 'ğŸ­ ØªØ­ÙˆÙŠÙ„' : 'âš¡ ØªÙˆØ²ÙŠØ¹'));
            bounds.push([parseFloat(s.lat), parseFloat(s.lng)]);
        });
        if (bounds.length > 1) nearbyMap.fitBounds(bounds, { padding: [30, 30] });
        // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø·Ø§Øª Ø§Ù„Ù‚Ø±ÙŠØ¨Ø© ÙƒØ¨Ø·Ø§Ù‚Ø§Øª
        var nearbyStations = stations.filter(function(s){return s.number !== center.number;});
        var listHtml = '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.75rem;"><span style="font-size:0.9rem;font-weight:600;color:var(--sec-orange);">ğŸ—ºï¸ ' + nearbyStations.length + ' Ù…Ø­Ø·Ø© ÙÙŠ Ù…Ø­ÙŠØ· 1.5 ÙƒÙ…</span><span style="font-size:0.7rem;color:var(--text-secondary);">ğŸŸ¢ ØªÙˆØ²ÙŠØ¹ | ğŸŸ£ ØªØ­ÙˆÙŠÙ„</span></div>';
        listHtml += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:0.5rem;max-height:250px;overflow-y:auto;padding:0.25rem;">';
        nearbyStations.slice(0, 20).forEach(function(s) {
            var bgColor = s.type === 'substation' ? 'linear-gradient(135deg,rgba(155,89,182,0.2),rgba(142,68,173,0.1))' : 'var(--bg-input)';
            var borderColor = s.type === 'substation' ? '#9b59b6' : '#27ae60';
            var typeIcon = s.type === 'substation' ? 'ğŸ­' : 'âš¡';
            var url = s.googleMap || (s.lat && s.lng ? 'https://www.google.com/maps?q=' + s.lat + ',' + s.lng : '');
            listHtml += '<div style="background:' + bgColor + ';padding:0.6rem;border-radius:0.5rem;border-right:4px solid ' + borderColor + ';transition:0.2s;" onmouseover="this.style.transform=\'scale(1.02)\'" onmouseout="this.style.transform=\'scale(1)\'">';
            listHtml += '<div style="font-weight:700;font-size:0.85rem;color:var(--text-primary);margin-bottom:0.25rem;">' + typeIcon + ' ' + s.number + '</div>';
            listHtml += '<div style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:0.3rem;">ğŸ“ ' + s.distance + ' ÙƒÙ…</div>';
            if (url) listHtml += '<a href="' + url + '" target="_blank" style="font-size:0.7rem;color:' + borderColor + ';text-decoration:none;font-weight:600;">ğŸ—ºï¸ ÙØªØ­ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</a>';
            listHtml += '</div>';
        });
        listHtml += '</div>';
        if (nearbyStations.length > 20) {
            listHtml += '<div style="text-align:center;margin-top:0.5rem;font-size:0.75rem;color:var(--text-secondary);">Ùˆ ' + (nearbyStations.length - 20) + ' Ù…Ø­Ø·Ø© Ø£Ø®Ø±Ù‰...</div>';
        }
        document.getElementById('nearbyList').innerHTML = listHtml;
    }
    
    function renderFeederMap(center, stations) {
        var mapDiv = document.getElementById('nearbyMap');
        if (nearbyMap) { nearbyMap.remove(); nearbyMap = null; }
        nearbyMap = L.map(mapDiv).setView([parseFloat(center.lat), parseFloat(center.lng)], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(nearbyMap);
        // Ø§Ù„Ù…Ø­Ø·Ø© Ø§Ù„Ù…Ø¨Ø­ÙˆØ«Ø© - Ø¯Ø¨ÙˆØ³ Ø¨Ø§Ø±Ø²
        var centerIcon = L.divIcon({ className: 'custom-marker', html: '<div style="font-size:28px;text-shadow:2px 2px 4px rgba(0,0,0,0.5);">ğŸ“</div>', iconSize: [28, 28], iconAnchor: [14, 28] });
        L.marker([parseFloat(center.lat), parseFloat(center.lng)], { icon: centerIcon }).addTo(nearbyMap).bindPopup('<b style="color:#e8a54b;font-size:1.1rem;">' + center.number + '</b><br>ğŸ¯ Ø§Ù„Ù…Ø­Ø·Ø© Ø§Ù„Ù…Ø¨Ø­ÙˆØ«Ø©').openPopup();
        var bounds = [[parseFloat(center.lat), parseFloat(center.lng)]];
        stations.forEach(function(s) {
            var icon = L.divIcon({ className: 'custom-marker', html: '<div style="background:#3498db;width:14px;height:14px;border-radius:50%;border:2px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.3);"></div>', iconSize: [14, 14], iconAnchor: [7, 7] });
            L.marker([parseFloat(s.lat), parseFloat(s.lng)], { icon: icon }).addTo(nearbyMap).bindPopup('<b>' + s.number + '</b><br>ğŸ“ ' + s.distance + ' ÙƒÙ…');
            bounds.push([parseFloat(s.lat), parseFloat(s.lng)]);
        });
        if (bounds.length > 1) nearbyMap.fitBounds(bounds, { padding: [30, 30] });
        // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ù…Ø­Ø·Ø§Øª Ø§Ù„Ù…ØºØ°ÙŠ ÙƒØ¨Ø·Ø§Ù‚Ø§Øª
        var listHtml = '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.75rem;"><span style="font-size:0.9rem;font-weight:600;color:var(--sec-orange);">ğŸ”Œ ' + stations.length + ' Ù…Ø­Ø·Ø© Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ù…ØºØ°ÙŠ</span></div>';
        listHtml += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:0.5rem;max-height:250px;overflow-y:auto;padding:0.25rem;">';
        stations.slice(0, 20).forEach(function(s) {
            var url = s.googleMap || (s.lat && s.lng ? 'https://www.google.com/maps?q=' + s.lat + ',' + s.lng : '');
            listHtml += '<div style="background:var(--bg-input);padding:0.6rem;border-radius:0.5rem;border-right:4px solid #3498db;transition:0.2s;" onmouseover="this.style.transform=\'scale(1.02)\'" onmouseout="this.style.transform=\'scale(1)\'">';
            listHtml += '<div style="font-weight:700;font-size:0.85rem;color:var(--text-primary);margin-bottom:0.25rem;">âš¡ ' + s.number + '</div>';
            listHtml += '<div style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:0.3rem;">ğŸ“ ' + s.distance + ' ÙƒÙ…</div>';
            if (url) listHtml += '<a href="' + url + '" target="_blank" style="font-size:0.7rem;color:#3498db;text-decoration:none;font-weight:600;">ğŸ—ºï¸ ÙØªØ­ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</a>';
            listHtml += '</div>';
        });
        listHtml += '</div>';
        document.getElementById('nearbyList').innerHTML = listHtml;
    }

    function openAddModal(t) { 
        if (t === 'distribution') { 
            document.getElementById('addDistributionModal').classList.add('active'); 
            ['addDistNumber', 'addDistFeeder', 'addDistRegion', 'addDistLat', 'addDistLng', 'addDistReason', 'addDistCoordsManual'].forEach(function(id) { var el = document.getElementById(id); if (el) el.value = ''; }); 
            document.getElementById('addDistLocationBtn').classList.remove('active');
        } else { 
            document.getElementById('addSubstationModal').classList.add('active'); 
            ['addSubShortName', 'addSubLat', 'addSubLng', 'addSubReason', 'addSubCoordsManual'].forEach(function(id) { var el = document.getElementById(id); if (el) el.value = ''; }); 
            document.getElementById('addSubLocationBtn').classList.remove('active');
        } 
    }
    
    function getCurrentLocation(pfx) { 
        var btn = document.getElementById(pfx + 'LocationBtn'), lat = document.getElementById(pfx + 'Lat') || document.getElementById(pfx + 'Latitude'), lng = document.getElementById(pfx + 'Lng') || document.getElementById(pfx + 'Longitude'); 
        btn.innerHTML = '<div class="spinner"></div><span>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ¯...</span>'; 
        if (navigator.geolocation) { 
            navigator.geolocation.getCurrentPosition(function(p) { 
                lat.value = p.coords.latitude.toFixed(8); 
                lng.value = p.coords.longitude.toFixed(8); 
                btn.classList.add('active'); 
                btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg><span>ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ¯</span>'; 
                showToast('ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹'); 
                var manualInput = document.getElementById(pfx + 'CoordsManual'); 
                if (manualInput) manualInput.value = ''; 
            }, function() { 
                btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4z"/></svg><span>ğŸ“ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ (GPS)</span>'; 
                showToast('ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ¯', 'error'); 
            }, { enableHighAccuracy: true, timeout: 15000 }); 
        } 
    }
    
    function parseManualCoords(pfx) {
        var manualInput = document.getElementById(pfx + 'CoordsManual');
        var latInput = document.getElementById(pfx + 'Lat') || document.getElementById(pfx + 'Latitude');
        var lngInput = document.getElementById(pfx + 'Lng') || document.getElementById(pfx + 'Longitude');
        var btn = document.getElementById(pfx + 'LocationBtn');
        if (!manualInput || !latInput || !lngInput) return;
        var value = manualInput.value.trim().replace(/\s+/g, '');
        if (!value) { showToast('Ø§Ø¯Ø®Ù„ Ø§Ù„Ø§Ø­Ø¯Ø§Ø«ÙŠØ§Øª', 'warning'); return; }
        var lat, lng;
        if (value.indexOf(',') !== -1) {
            var parts = value.split(',');
            if (parts.length === 2) { lat = parseFloat(parts[0]); lng = parseFloat(parts[1]); }
        }
        if (isNaN(lat) || isNaN(lng)) { showToast('ØµÙŠØºØ© Ø®Ø§Ø·Ø¦Ø©', 'error'); return; }
        if (lat < -90 || lat > 90 || lng < -180 || lng > 180) { showToast('Ø§Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚', 'error'); return; }
        latInput.value = lat.toFixed(8);
        lngInput.value = lng.toFixed(8);
        if (btn) { btn.classList.add('active'); btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg><span>ØªÙ… Ø§Ù„Ø§Ø¯Ø®Ø§Ù„</span>'; }
        manualInput.classList.add('valid');
        setTimeout(function() { manualInput.classList.remove('valid'); }, 3000);
        showToast('ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø§Ø­Ø¯Ø§Ø«ÙŠØ§Øª');
    }
    
    async function submitAddDistribution() { 
        if (!isOnline()) { showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª', 'error'); return; }
        var n = document.getElementById('addDistNumber').value.trim(), rg = document.getElementById('addDistRegion').value.trim(); 
        if (!n || !rg) { showToast('Ø§ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error'); return; } 
        if (searchStationLocal(n).found) { showToast('Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§', 'error'); return; } 
        var fd = document.getElementById('addDistFeeder').value.trim(), lt = document.getElementById('addDistLat').value, lg = document.getElementById('addDistLng').value, rs = document.getElementById('addDistReason').value.trim(); 
        closeModal('addDistributionModal'); 
        showToast('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø¶Ø§ÙØ©...', 'warning'); 
        var ns = { number: n, feeder: fd, region: rg, lat: lt, lng: lg, type: 'distribution', typeLabel: 'ØªÙˆØ²ÙŠØ¹', googleMap: (lt && lg) ? 'https://www.google.com/maps?q=' + lt + ',' + lg : '' }; 
        var r = await apiPost({ action: 'addStation', number: n, region: rg, feeder: fd, lat: lt, lng: lg, reason: rs, userName: currentUser ? currentUser.name : '', userPhone: currentUser ? currentUser.phone : '' }); 
        if (r.error) { showToast(r.error, 'error'); return; } 
        allStations.push(ns); 
        saveToCache(allStations);
        updateCacheStatus('loaded', allStations.length + ' Ù…Ø­Ø·Ø©'); 
        showToast('ØªÙ…Øª Ø§Ù„Ø§Ø¶Ø§ÙØ©'); 
        document.getElementById('searchInput').value = n; 
        searchStation(); 
    }
    
    async function submitAddSubstation() { 
        if (!isOnline()) { showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª', 'error'); return; }
        var sn = document.getElementById('addSubShortName').value.trim().toUpperCase(); 
        if (!sn) { showToast('Ø§Ø¯Ø®Ù„ Ø§Ù„Ø§Ø®ØªØµØ§Ø±', 'error'); return; } 
        if (searchStationLocal(sn).found) { showToast('Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§', 'error'); return; } 
        var lt = document.getElementById('addSubLat').value, lg = document.getElementById('addSubLng').value, rs = document.getElementById('addSubReason').value.trim(); 
        closeModal('addSubstationModal'); 
        showToast('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø¶Ø§ÙØ©...', 'warning'); 
        var ns = { number: sn, shortName: sn, lat: lt, lng: lg, type: 'substation', typeLabel: 'ØªØ­ÙˆÙŠÙ„', googleMap: (lt && lg) ? 'https://www.google.com/maps?q=' + lt + ',' + lg : '' }; 
        var r = await apiPost({ action: 'addSubstation', shortName: sn, lat: lt, lng: lg, reason: rs, userName: currentUser ? currentUser.name : '', userPhone: currentUser ? currentUser.phone : '' }); 
        if (r.error) { showToast(r.error, 'error'); return; } 
        allStations.push(ns); 
        saveToCache(allStations);
        updateCacheStatus('loaded', allStations.length + ' Ù…Ø­Ø·Ø©'); 
        showToast('ØªÙ…Øª Ø§Ù„Ø§Ø¶Ø§ÙØ©'); 
        document.getElementById('searchInput').value = sn; 
        searchStation(); 
    }
    
    async function submitEdit() { 
        if (!isOnline()) { showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª', 'error'); return; }
        var n = document.getElementById('editStationNumber').value.trim(); 
        if (!n) { showToast('Ø®Ø·Ø§ ÙÙŠ Ø§Ù„Ø±Ù‚Ù…', 'error'); return; } 
        var lt = document.getElementById('editLatitude').value.trim();
        var lg = document.getElementById('editLongitude').value.trim();
        var rs = document.getElementById('editReason').value.trim(); 
        closeModal('editModal'); 
        showToast('Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„...', 'warning'); 
        var idx = -1;
        for (var i = 0; i < allStations.length; i++) {
            if (String(allStations[i].number).toUpperCase() === n.toUpperCase()) { idx = i; break; }
        }
        if (idx === -1) { showToast('ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error'); return; }
        var old = JSON.parse(JSON.stringify(allStations[idx])); 
        var act = editingStationType === 'distribution' ? 'editStation' : 'editSubstation';
        var data = editingStationType === 'distribution' 
            ? { action: act, number: n, feeder: document.getElementById('editFeeder').value.trim(), region: document.getElementById('editRegion').value.trim(), lat: lt, lng: lg, reason: rs, userName: currentUser ? currentUser.name : '', userPhone: currentUser ? currentUser.phone : '' } 
            : { action: act, shortName: n, lat: lt, lng: lg, reason: rs, userName: currentUser ? currentUser.name : '', userPhone: currentUser ? currentUser.phone : '' }; 
        var r = await apiPost(data); 
        if (r.error) { showToast(r.error, 'error'); return; } 
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¨Ø¹Ø¯ Ù†Ø¬Ø§Ø­ Ø§Ù„Ø­ÙØ¸
        if (editingStationType === 'distribution') { 
            allStations[idx].feeder = document.getElementById('editFeeder').value.trim(); 
            allStations[idx].region = document.getElementById('editRegion').value.trim(); 
        } 
        if (lt && lg) { 
            allStations[idx].lat = lt; 
            allStations[idx].lng = lg; 
            allStations[idx].googleMap = 'https://www.google.com/maps?q=' + lt + ',' + lg; 
        }
        saveToCache(allStations);
        showToast('ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„'); 
        document.getElementById('searchInput').value = n; 
        searchStation(); 
    }

    function openFaultModal() { document.getElementById('faultModal').classList.add('active'); for (var i = 1; i <= 6; i++) { var inp = document.getElementById('fault' + i); if (inp) { inp.value = ''; inp.className = ''; } } document.getElementById('faultResults').style.display = 'none'; }
    
    async function searchFaultStations() { 
        var nums = []; 
        for (var i = 1; i <= 6; i++) { var v = document.getElementById('fault' + i).value.trim(); if (v) nums.push({ i: i, v: v }); } 
        if (nums.length < 2) { showToast('Ø§Ø¯Ø®Ù„ 2 Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù‚Ù„', 'warning'); return; } 
        if (!isStationsLoaded) { showLoading(); await loadStationsCache(); hideLoading(); } 
        faultStations = []; 
        var tb = document.getElementById('faultTableBody'); 
        tb.innerHTML = ''; 
        var lbl = ['A', 'B', 'C', 'D', 'E', 'F']; 
        var fc = 0; 
        for (var j = 0; j < nums.length; j++) { 
            var item = nums[j];
            var inp = document.getElementById('fault' + item.i);
            var r = searchStationLocal(item.v); 
            if (r.found) { 
                inp.classList.remove('not-found'); inp.classList.add('found'); 
                r.station.label = lbl[fc]; 
                faultStations.push(r.station); 
                fc++; 
                var tl = r.station.type === 'substation' ? '<span class="type-badge type-substation">ØªØ­ÙˆÙŠÙ„</span>' : '<span class="type-badge type-distribution">ØªÙˆØ²ÙŠØ¹</span>'; 
                tb.innerHTML += '<tr><td><span class="point-label">' + r.station.label + '</span></td><td><strong>' + r.station.number + '</strong></td><td>' + tl + '</td><td><span class="status-found">âœ“</span></td></tr>'; 
            } else { 
                inp.classList.remove('found'); inp.classList.add('not-found'); 
                tb.innerHTML += '<tr><td>-</td><td><strong>' + item.v + '</strong></td><td>-</td><td><span class="status-not-found">âœ•</span></td></tr>'; 
            } 
        } 
        document.getElementById('faultCount').textContent = fc; 
        document.getElementById('faultResults').style.display = 'block'; 
        if (fc >= 1) { renderFaultMap(); generateNavigationLink(); calculateTotalDistance(); } 
        else { showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬', 'warning'); } 
    }
    
    function renderFaultMap() {
        var mapDiv = document.getElementById('faultMapContainer');
        if (faultMap) { faultMap.remove(); faultMap = null; }
        var validStations = faultStations.filter(function(s) { return s.lat && s.lng; });
        if (validStations.length === 0) return;
        var firstStation = validStations[0];
        faultMap = L.map(mapDiv).setView([parseFloat(firstStation.lat), parseFloat(firstStation.lng)], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(faultMap);
        var bounds = [];
        validStations.forEach(function(s) {
            var icon = L.divIcon({ className: 'custom-marker', html: '<div style="background:var(--danger);width:24px;height:24px;border-radius:50%;border:3px solid white;display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:12px;">' + s.label + '</div>', iconSize: [24, 24], iconAnchor: [12, 12] });
            L.marker([parseFloat(s.lat), parseFloat(s.lng)], { icon: icon }).addTo(faultMap).bindPopup('<b>' + s.label + ': ' + s.number + '</b>');
            bounds.push([parseFloat(s.lat), parseFloat(s.lng)]);
        });
        if (bounds.length > 1) {
            faultMap.fitBounds(bounds, { padding: [30, 30] });
            var latlngs = bounds.map(function(b) { return [b[0], b[1]]; });
            L.polyline(latlngs, { color: '#e57373', weight: 3, dashArray: '10, 10' }).addTo(faultMap);
        }
    }
    
    function generateNavigationLink() {
        var validStations = faultStations.filter(function(s) { return s.lat && s.lng; });
        if (validStations.length === 0) return;
        var navUrl = 'https://www.google.com/maps/dir/';
        validStations.forEach(function(s) { navUrl += s.lat + ',' + s.lng + '/'; });
        document.getElementById('faultActions').innerHTML = '<a href="' + navUrl + '" target="_blank" class="nav-link"><svg viewBox="0 0 24 24" style="width:1.25rem;height:1.25rem;fill:white;"><path d="M21.71 11.29l-9-9c-.39-.39-1.02-.39-1.41 0l-9 9c-.39.39-.39 1.02 0 1.41l9 9c.39.39 1.02.39 1.41 0l9-9c.39-.38.39-1.01 0-1.41zM14 14.5V12h-4v3H8v-4c0-.55.45-1 1-1h5V7.5l3.5 3.5-3.5 3.5z"/></svg>ÙØªØ­ Ø§Ù„Ù…Ù„Ø§Ø­Ø©</a><div class="total-distance" id="totalDistance"></div>';
    }
    
    function calculateTotalDistance() {
        var validStations = faultStations.filter(function(s) { return s.lat && s.lng; });
        if (validStations.length < 2) return;
        var total = 0;
        for (var i = 0; i < validStations.length - 1; i++) {
            var d = calcDistance(parseFloat(validStations[i].lat), parseFloat(validStations[i].lng), parseFloat(validStations[i+1].lat), parseFloat(validStations[i+1].lng));
            total += d;
        }
        document.getElementById('totalDistance').innerHTML = 'ğŸ“ Ø§Ù„Ù…Ø³Ø§ÙØ©: ' + total.toFixed(2) + ' ÙƒÙ…';
    }

    async function loadAdminData() { 
        // Ø¥Ø¸Ù‡Ø§Ø± Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙÙŠ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
        document.getElementById('totalDistribution').textContent = '...';
        document.getElementById('totalSubstations').textContent = '...';
        document.getElementById('totalUsers').textContent = '...';
        document.getElementById('totalAdditions').textContent = '...';
        document.getElementById('totalEdits').textContent = '...';
        document.getElementById('onlineCount').textContent = '...';
        document.getElementById('onlineBadge').textContent = '...';
        
        // ØªØ­Ù…ÙŠÙ„ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„ØªÙˆØ§Ø²ÙŠ (Ø£Ø³Ø±Ø¹ 5 Ù…Ø±Ø§Øª!)
        try {
            var [stats, online, daily, users, logs] = await Promise.all([
                apiGet('getStats'),
                apiGet('getOnlineUsers'),
                apiGet('getDailyStats'),
                apiGet('getUsers'),
                apiGet('getLogs')
            ]);
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            if (stats.stats) { 
                document.getElementById('totalDistribution').textContent = stats.stats.totalDistribution || 0; 
                document.getElementById('totalSubstations').textContent = stats.stats.totalSubstations || 0; 
                document.getElementById('totalUsers').textContent = stats.stats.totalUsers || 0; 
                document.getElementById('totalAdditions').textContent = stats.stats.totalAdditions || 0; 
                document.getElementById('totalEdits').textContent = stats.stats.totalEdits || 0; 
                document.getElementById('onlineCount').textContent = stats.stats.onlineCount || 0;
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙŠÙ†
            if (online.success) {
                document.getElementById('onlineBadge').textContent = online.count || 0;
                var onlineList = document.getElementById('onlineUsersList');
                if (online.users && online.users.length > 0) {
                    onlineList.innerHTML = online.users.map(function(u) { return '<div class="online-user-card"><div class="online-user-avatar">' + (u.name ? u.name.charAt(0) : '?') + '</div><div class="online-user-info"><div class="online-user-name">' + (u.name || 'Ù…Ø³ØªØ®Ø¯Ù…') + '</div><div class="online-user-time">ğŸ• ' + (u.lastActive ? u.lastActive.split(' ')[1] : '') + '</div></div><div class="online-indicator"></div></div>'; }).join('');
                } else { onlineList.innerHTML = '<div class="empty-online">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØªÙˆØ§Ø¬Ø¯ÙˆÙ†</div>'; }
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
            if (daily.success) renderCharts(daily);
            
            // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
            if (users.users) document.getElementById('adminUsersBody').innerHTML = users.users.map(function(u) { return '<tr><td>' + u.name + '</td><td>' + u.phone + '</td><td>' + (u.type||'Ù…ÙˆØ¸Ù') + '</td><td>' + (u.registerDate||'-') + '</td></tr>'; }).join('');
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„Ø§Øª
            if (logs.logs) document.getElementById('adminLogsBody').innerHTML = logs.logs.slice(-30).reverse().map(function(l) { return '<tr><td style="color:' + (l.type.indexOf('Ø§Ø¶Ø§ÙØ©') !== -1 ? 'var(--success)' : 'var(--warning)') + '">' + l.type + '</td><td>' + l.station + '</td><td>' + l.user + '</td><td>' + l.date + '</td></tr>'; }).join('');
        } catch (e) {
            console.error('Error loading admin data:', e);
        }
    }
    
    function renderCharts(d) { 
        new Chart(document.getElementById('visitsChart'), { 
            type: 'line', 
            data: { labels: d.dailyVisits.map(function(x) { return x.date.slice(5); }), datasets: [{ label: 'Ø²ÙŠØ§Ø±Ø§Øª', data: d.dailyVisits.map(function(x) { return x.count; }), borderColor: '#e8a54b', backgroundColor: 'rgba(232,165,75,0.2)', fill: true, tension: 0.4 }] }, 
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { color: '#c5ddf0' }, grid: { color: '#5b8fb9' } }, x: { ticks: { color: '#c5ddf0' }, grid: { color: '#5b8fb9' } } } } 
        }); 
        new Chart(document.getElementById('activityChart'), { 
            type: 'bar', 
            data: { labels: d.dailyActivity.map(function(x) { return x.date.slice(5); }), datasets: [{ label: 'Ø§Ø¶Ø§ÙØ§Øª', data: d.dailyActivity.map(function(x) { return x.additions; }), backgroundColor: '#5cb85c' }, { label: 'ØªØ¹Ø¯ÙŠÙ„Ø§Øª', data: d.dailyActivity.map(function(x) { return x.edits; }), backgroundColor: '#e8a54b' }] }, 
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#c5ddf0' } } }, scales: { y: { beginAtZero: true, ticks: { color: '#c5ddf0' }, grid: { color: '#5b8fb9' } }, x: { ticks: { color: '#c5ddf0' }, grid: { color: '#5b8fb9' } } } } 
        }); 
    }

    window.addEventListener('beforeinstallprompt', function(e) { e.preventDefault(); deferredPrompt = e; showInstallBanner(); });
    function showInstallBanner() { var b = document.getElementById('installBtn'); if (b && !localStorage.getItem('installBannerClosed')) { b.classList.add('show'); document.body.classList.add('install-visible'); } }
    function hideInstallBanner(e) { if (e) e.stopPropagation(); var b = document.getElementById('installBtn'); if (b) { b.classList.remove('show'); document.body.classList.remove('install-visible'); localStorage.setItem('installBannerClosed', 'true'); } }
    function installApp() { if (deferredPrompt) { deferredPrompt.prompt(); deferredPrompt.userChoice.then(function(r) { deferredPrompt = null; hideInstallBanner(); if (r.outcome === 'accepted') showToast('ØªÙ… Ø§Ù„ØªØ«Ø¨ÙŠØª'); }); } }
    function checkIOSInstall() { var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent); var isStandalone = window.navigator.standalone; if (isIOS && !isStandalone && !localStorage.getItem('iosPromptShown')) { setTimeout(function() { }, 3000); } }

    document.addEventListener('DOMContentLoaded', function() {
        checkSession();
        checkIOSInstall();
        loadContactPhone();
    });
    document.querySelectorAll('.modal-overlay').forEach(function(m) { m.addEventListener('click', function(e) { if (e.target === m) m.classList.remove('active'); }); });
</script>
```

</body>
</html>