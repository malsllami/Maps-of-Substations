<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#f77f00">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ù…Ø­Ø·Ø§Øª SEC">
    <link rel="manifest" id="manifest-placeholder">
    <title>Ù†Ø¸Ø§Ù… Ù…Ø­Ø·Ø§Øª SEC - Ø¬Ø¯Ø©</title>
    <script>
        // Ø¥Ù†Ø´Ø§Ø¡ manifest Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹
        const manifest = {
            "name": "Ù†Ø¸Ø§Ù… Ù…Ø­Ø·Ø§Øª SEC - Ø¬Ø¯Ø©",
            "short_name": "SEC Ù…Ø­Ø·Ø§Øª",
            "description": "Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…Ø­Ø·Ø§Øª Ø§Ù„ØªÙˆØ²ÙŠØ¹ ÙˆØ§Ù„ØªØ­ÙˆÙŠÙ„",
            "start_url": "./",
            "display": "standalone",
            "background_color": "#1e3a5f",
            "theme_color": "#e8a54b",
            "orientation": "portrait-primary",
            "icons": [
                {
                    "src": "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23e8a54b' width='100' height='100' rx='20'/><text x='50' y='65' text-anchor='middle' fill='white' font-size='50'>âš¡</text></svg>",
                    "sizes": "192x192",
                    "type": "image/svg+xml",
                    "purpose": "any maskable"
                }
            ]
        };
        const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
        document.getElementById('manifest-placeholder').setAttribute('href', URL.createObjectURL(blob));
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&family=Cairo:wght@600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root {
            --sec-orange: #e8a54b;
            --sec-orange-light: #f5c77e;
            --sec-orange-dark: #d4923a;
            --sec-blue: #1e3a5f;
            --sec-blue-light: #2d4a6f;
            --sec-blue-lighter: #5b8fb9;
            --sec-blue-pale: #c5ddf0;
            --success: #5cb85c;
            --warning: #f0c36d;
            --danger: #e57373;
            --bg-dark: #1e3a5f;
            --bg-card: #274a6f;
            --bg-input: #2d5a7f;
            --text-primary: #ffffff;
            --text-secondary: #c5ddf0;
            --border: #5b8fb9;
            --gradient-sec: linear-gradient(135deg, #e8a54b 0%, #f5c77e 100%);
            --shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { font-size: 16px; }
        @media (max-width: 768px) { html { font-size: 14px; } }
        @media (max-width: 480px) { html { font-size: 13px; } }
        body { font-family: 'Tajawal', sans-serif; background: var(--bg-dark); color: var(--text-primary); min-height: 100vh; }
        .page { display: none; animation: fadeIn 0.4s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .login-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 1rem; }
        .login-card { background: var(--bg-card); border-radius: 1.5rem; padding: 2rem; width: 100%; max-width: 26rem; box-shadow: var(--shadow); border: 1px solid var(--border); }
        .logo-section { text-align: center; margin-bottom: 1.5rem; }
        .logo-icon { width: 4rem; height: 4rem; background: var(--gradient-sec); border-radius: 1rem; display: flex; align-items: center; justify-content: center; margin: 0 auto 0.75rem; font-size: 2rem; }
        .logo-section h1 { font-family: 'Cairo', sans-serif; font-size: 1.3rem; background: var(--gradient-sec); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .logo-section p { font-size: 0.85rem; color: var(--text-secondary); }

        .tabs { display: flex; margin-bottom: 1.25rem; background: var(--bg-input); border-radius: 0.75rem; padding: 0.25rem; }
        .tab { flex: 1; padding: 0.75rem; text-align: center; cursor: pointer; border-radius: 0.5rem; font-weight: 600; color: var(--text-secondary); transition: 0.3s; }
        .tab.active { background: var(--gradient-sec); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.4rem; font-weight: 500; color: var(--text-secondary); font-size: 0.85rem; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.75rem 1rem; background: var(--bg-input); border: 2px solid var(--border); border-radius: 0.625rem; color: var(--text-primary); font-family: 'Tajawal', sans-serif; font-size: 1rem; }
        .form-group input:focus { outline: none; border-color: var(--sec-orange); }
        .form-group input.error { border-color: var(--danger); }
        .form-group input.valid { border-color: var(--success); }
        .input-hint { font-size: 0.75rem; margin-top: 0.25rem; color: var(--text-secondary); }
        .input-hint.error { color: var(--danger); }
        .input-hint.success { color: var(--success); }
        .form-row { display: flex; gap: 0.75rem; }
        .form-row .form-group { flex: 1; }
        
        .password-wrapper { position: relative; }
        .password-wrapper input { padding-left: 2.5rem; }
        .password-toggle { position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-secondary); cursor: pointer; }

        .btn { width: 100%; padding: 0.75rem; border: none; border-radius: 0.625rem; font-family: 'Tajawal', sans-serif; font-size: 1rem; font-weight: 600; cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .btn-primary { background: var(--gradient-sec); color: white; }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); }
        .btn-secondary { background: transparent; border: 2px solid var(--sec-orange); color: var(--sec-orange); }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: #1a1a1a; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn svg { width: 1.125rem; height: 1.125rem; fill: currentColor; }

        .admin-link { text-align: center; margin-top: 1rem; }
        .admin-link a { color: var(--text-secondary); text-decoration: none; font-size: 0.85rem; }

        .install-btn { position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(135deg, #e8a54b 0%, #d4923a 100%); color: white; border: none; padding: 0.75rem 1rem; font-family: 'Tajawal', sans-serif; font-weight: 600; cursor: pointer; display: none; align-items: center; justify-content: center; gap: 0.5rem; z-index: 1000; font-size: 0.9rem; }
        .install-btn.show { display: flex; }
        .install-btn svg { width: 1.25rem; height: 1.25rem; fill: currentColor; }
        .install-btn .close-install { position: absolute; left: 1rem; background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; opacity: 0.7; }
        .install-btn .close-install:hover { opacity: 1; }
        
        /* Ø¥Ø²Ø§Ø­Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¹Ù†Ø¯ Ø¸Ù‡ÙˆØ± Ø²Ø± Ø§Ù„ØªØ«Ø¨ÙŠØª */
        body.install-visible .page { padding-top: 3rem; }

        .dashboard-container { min-height: 100vh; padding: 1rem; max-width: 1200px; margin: 0 auto; }
        .header { background: var(--bg-card); border-radius: 1rem; padding: 1rem; margin-bottom: 1.25rem; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 0.75rem; border: 1px solid var(--border); }
        .header-right { display: flex; align-items: center; gap: 0.75rem; }
        .header-logo { width: 2.5rem; height: 2.5rem; background: var(--gradient-sec); border-radius: 0.625rem; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; }
        .header-title { font-family: 'Cairo', sans-serif; font-size: 1rem; font-weight: 700; }
        .header-subtitle { font-size: 0.75rem; color: var(--text-secondary); }
        .header-left { display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; }
        
        .cache-status { display: flex; align-items: center; gap: 0.4rem; padding: 0.4rem 0.75rem; background: var(--bg-input); border-radius: 0.5rem; font-size: 0.75rem; cursor: pointer; transition: 0.3s; }
        .cache-status:hover { background: var(--sec-orange); }
        .cache-status.loaded .cache-text { color: var(--success); }
        .cache-status.loading .cache-text { color: var(--warning); }
        .cache-status.error .cache-text { color: var(--danger); }
        
        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ */
        .first-load-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(30, 58, 95, 0.95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            gap: 1.5rem;
        }
        .first-load-overlay.active { display: flex; }
        .first-load-logo { font-size: 4rem; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .first-load-text { font-size: 1.1rem; color: var(--text-primary); }
        .first-load-progress { width: 80%; max-width: 300px; height: 8px; background: var(--bg-input); border-radius: 4px; overflow: hidden; }
        .first-load-bar { height: 100%; background: var(--gradient-sec); width: 0%; transition: width 0.3s; border-radius: 4px; }
        .first-load-count { font-size: 0.9rem; color: var(--text-secondary); }
        .first-load-done { color: var(--success); font-size: 1.2rem; display: none; }
        .first-load-done.show { display: block; animation: fadeIn 0.5s; }
        
        .user-info { display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0.75rem; background: var(--bg-input); border-radius: 0.5rem; }
        .user-avatar { width: 2rem; height: 2rem; background: var(--sec-orange); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; }
        .user-name { font-weight: 600; font-size: 0.85rem; }
        .user-type { font-size: 0.7rem; color: var(--text-secondary); }
        
        .whatsapp-btn { 
            display: flex; 
            align-items: center; 
            justify-content: center;
            width: 2.2rem; 
            height: 2.2rem; 
            background: #25D366; 
            border-radius: 50%; 
            border: none;
            cursor: pointer; 
            transition: 0.3s;
            box-shadow: 0 2px 8px rgba(37, 211, 102, 0.4);
        }
        .whatsapp-btn:hover { 
            transform: scale(1.1); 
            box-shadow: 0 4px 15px rgba(37, 211, 102, 0.6);
        }
        .whatsapp-btn svg { width: 1.3rem; height: 1.3rem; fill: white; }
        
        .logout-btn { padding: 0.4rem 0.75rem; background: transparent; border: 2px solid var(--danger); color: var(--danger); border-radius: 0.5rem; cursor: pointer; font-family: 'Tajawal', sans-serif; font-weight: 500; font-size: 0.8rem; display: flex; align-items: center; gap: 0.3rem; }
        .logout-btn:hover { background: var(--danger); color: white; }
        .logout-btn svg { width: 1rem; height: 1rem; fill: currentColor; }

        .search-section { background: var(--bg-card); border-radius: 1rem; padding: 1.25rem; margin-bottom: 1.25rem; border: 1px solid var(--border); }
        .search-header { display: flex; align-items: center; gap: 0.625rem; margin-bottom: 1rem; }
        .search-header svg { width: 1.5rem; height: 1.5rem; fill: var(--sec-orange); }
        .search-header h2 { font-family: 'Cairo', sans-serif; font-size: 1.1rem; }
        .search-box { display: flex; gap: 0.625rem; flex-wrap: wrap; }
        .search-input-wrapper { flex: 1; min-width: 12rem; }
        .search-input-wrapper input { width: 100%; padding: 0.75rem 1rem; background: var(--bg-input); border: 2px solid var(--border); border-radius: 0.625rem; color: var(--text-primary); font-size: 1rem; }
        .search-input-wrapper input:focus { border-color: var(--sec-orange); outline: none; }
        
        .action-buttons { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .action-btn { padding: 0.75rem 1rem; border: none; border-radius: 0.625rem; font-family: 'Tajawal', sans-serif; font-size: 0.85rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.4rem; white-space: nowrap; transition: 0.3s; }
        .action-btn svg { width: 1.125rem; height: 1.125rem; fill: currentColor; }
        .btn-search { background: var(--gradient-sec); color: white; }
        .btn-add { background: var(--success); color: white; }
        .btn-add-sub { background: var(--sec-blue-lighter); color: white; }
        .btn-edit { background: var(--warning); color: #1a1a1a; }
        .btn-fault { background: var(--danger); color: white; }
        .action-btn:hover { transform: translateY(-2px); }

        .results-section { background: var(--bg-card); border-radius: 1rem; padding: 1.25rem; margin-bottom: 1.25rem; border: 1px solid var(--border); }
        .results-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border); flex-wrap: wrap; gap: 0.5rem; }
        .results-title { display: flex; align-items: center; gap: 0.5rem; }
        .results-title svg { width: 1.25rem; height: 1.25rem; fill: var(--sec-orange); }
        .results-title h3 { font-family: 'Cairo', sans-serif; font-size: 1rem; }
        .results-count { background: var(--sec-orange); padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.75rem; font-weight: 600; }
        
        .results-table-wrapper { overflow-x: auto; }
        .results-table { width: 100%; border-collapse: collapse; min-width: 400px; }
        .results-table th, .results-table td { padding: 0.75rem; text-align: right; border-bottom: 1px solid var(--border); font-size: 0.85rem; }
        .results-table th { background: var(--bg-input); font-weight: 600; color: var(--sec-blue-pale); }
        
        .type-badge { display: inline-block; padding: 0.2rem 0.5rem; border-radius: 0.25rem; font-size: 0.7rem; font-weight: 600; }
        .type-distribution { background: var(--sec-orange); color: white; }
        .type-substation { background: var(--sec-blue-lighter); color: white; }
        
        .results-table .btn-edit { 
            background: var(--warning); 
            color: #1a1a1a; 
            border: none;
            transition: 0.3s;
        }
        .results-table .btn-edit:hover { 
            background: #d4a84a; 
            transform: scale(1.05);
        }
        
        .map-link { display: inline-flex; align-items: center; gap: 0.3rem; padding: 0.3rem 0.6rem; background: var(--gradient-sec); color: white; text-decoration: none; border-radius: 0.375rem; font-size: 0.75rem; }
        .map-link svg { width: 0.875rem; height: 0.875rem; fill: currentColor; }
        
        .empty-state { text-align: center; padding: 2.5rem 1rem; }
        .empty-state svg { width: 4rem; height: 4rem; fill: var(--text-secondary); opacity: 0.5; margin-bottom: 0.75rem; }
        .empty-state h4 { font-size: 1rem; color: var(--text-secondary); }
        
        .not-found-card { background: rgba(252, 129, 129, 0.1); border: 2px solid var(--danger); border-radius: 0.875rem; padding: 2rem; text-align: center; }
        .not-found-card h4 { font-size: 1.1rem; color: var(--danger); }
        .not-found-card .searched-number { font-size: 1.5rem; font-weight: 700; color: var(--danger); margin: 0.75rem 0; }

        .map-section { background: var(--bg-card); border-radius: 1rem; padding: 1.25rem; margin-bottom: 1.25rem; border: 1px solid var(--border); }
        .map-container { height: 280px; border-radius: 0.625rem; overflow: hidden; margin-top: 0.75rem; }
        #nearbyMap, #faultMap { height: 100%; width: 100%; }
        .nearby-list { margin-top: 0.75rem; max-height: 10rem; overflow-y: auto; }
        .nearby-item { display: flex; align-items: center; justify-content: space-between; padding: 0.625rem 0.75rem; background: var(--bg-input); border-radius: 0.5rem; margin-bottom: 0.4rem; font-size: 0.85rem; }
        .nearby-number { font-weight: 700; color: var(--sec-orange-light); }
        .nearby-distance { font-size: 0.75rem; color: var(--text-secondary); }
        
        .feeder-toggle { display: flex; gap: 0.5rem; margin-top: 1rem; flex-wrap: wrap; }
        .feeder-btn { padding: 0.5rem 1rem; border: 2px solid var(--border); background: transparent; color: var(--text-secondary); border-radius: 2rem; cursor: pointer; font-family: 'Tajawal', sans-serif; font-size: 0.8rem; transition: 0.3s; display: flex; align-items: center; gap: 0.4rem; }
        .feeder-btn:hover { border-color: var(--sec-orange); color: var(--sec-orange); }
        .feeder-btn.active { background: var(--gradient-sec); border-color: var(--sec-orange); color: white; }
        .feeder-btn svg { width: 1rem; height: 1rem; fill: currentColor; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(26, 54, 93, 0.9); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 1rem; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--bg-card); border-radius: 1rem; width: 100%; max-width: 30rem; max-height: 90vh; overflow-y: auto; border: 1px solid var(--border); }
        .modal-header { padding: 1rem 1.25rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; background: var(--bg-card); }
        .modal-header h3 { font-family: 'Cairo', sans-serif; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem; }
        .modal-header h3 svg { width: 1.25rem; height: 1.25rem; fill: var(--sec-orange); }
        .modal-close { width: 2rem; height: 2rem; background: var(--bg-input); border: none; border-radius: 0.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .modal-close svg { width: 1rem; height: 1rem; fill: var(--text-secondary); }
        .modal-close:hover { background: var(--danger); }
        .modal-close:hover svg { fill: white; }
        .modal-body { padding: 1.25rem; }
        .modal-footer { padding: 1rem 1.25rem; border-top: 1px solid var(--border); display: flex; gap: 0.625rem; justify-content: flex-end; flex-wrap: wrap; }
        .modal-footer .btn { width: auto; min-width: 6rem; }
        
        .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
        .form-grid .form-group.full-width { grid-column: span 2; }
        .form-group textarea { min-height: 5rem; resize: vertical; }
        
        .location-btn { width: 100%; padding: 0.75rem; background: var(--bg-input); border: 2px dashed var(--border); border-radius: 0.625rem; color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; font-family: 'Tajawal', sans-serif; }
        .location-btn:hover { border-color: var(--sec-orange); color: var(--sec-orange); }
        .location-btn.active { border-color: var(--success); color: var(--success); background: rgba(72, 187, 120, 0.1); }
        .location-btn svg { width: 1.25rem; height: 1.25rem; fill: currentColor; }
        
        .coords-manual-input {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-top: 0.5rem;
        }
        .coords-manual-input input {
            flex: 1;
            padding: 0.6rem 0.75rem;
            background: var(--bg-input);
            border: 2px solid var(--border);
            border-radius: 0.5rem;
            color: var(--text-primary);
            font-family: 'Tajawal', monospace;
            font-size: 0.9rem;
            text-align: center;
            direction: ltr;
        }
        .coords-manual-input input:focus {
            border-color: var(--sec-orange);
            outline: none;
        }
        .coords-manual-input input.valid {
            border-color: var(--success);
            background: rgba(92, 184, 92, 0.1);
        }
        .coords-manual-input input.invalid {
            border-color: var(--danger);
        }
        .coords-manual-input .parse-btn {
            padding: 0.6rem 1rem;
            background: var(--sec-blue-lighter);
            border: none;
            border-radius: 0.5rem;
            color: white;
            cursor: pointer;
            font-family: 'Tajawal', sans-serif;
            font-weight: 600;
            white-space: nowrap;
        }
        .coords-manual-input .parse-btn:hover {
            background: var(--sec-orange);
        }
        .coords-hint {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
            text-align: center;
        }
        .coords-or {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin: 0.5rem 0;
        }

        .fault-inputs { display: flex; flex-direction: column; gap: 0.75rem; }
        .fault-input-row { display: flex; gap: 0.625rem; flex-wrap: wrap; }
        .fault-input-group { flex: 1; min-width: 5rem; }
        .fault-input-group label { display: block; font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem; }
        .fault-input-group input { width: 100%; padding: 0.625rem; background: var(--bg-input); border: 2px solid var(--border); border-radius: 0.5rem; color: var(--text-primary); text-align: center; }
        .fault-input-group input:focus { border-color: var(--sec-orange); outline: none; }
        .fault-input-group input.found { border-color: var(--success); background: rgba(72, 187, 120, 0.1); }
        .fault-input-group input.not-found { border-color: var(--danger); background: rgba(252, 129, 129, 0.1); }
        .status-found { color: var(--success); font-weight: 600; }
        .status-not-found { color: var(--danger); font-weight: 600; }
        .point-label { display: inline-flex; align-items: center; justify-content: center; width: 1.5rem; height: 1.5rem; background: var(--sec-orange); color: white; border-radius: 50%; font-weight: 700; font-size: 0.75rem; }
        .distance-badge { display: inline-block; padding: 0.25rem 0.75rem; background: var(--sec-blue-lighter); color: white; border-radius: 1rem; font-size: 0.85rem; font-weight: 600; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(8rem, 1fr)); gap: 0.875rem; margin-bottom: 1.25rem; }
        .stat-card { background: var(--bg-input); border-radius: 0.75rem; padding: 1rem; text-align: center; border: 1px solid var(--border); }
        .stat-card .number { font-size: 1.75rem; font-weight: 700; color: var(--sec-orange); }
        .stat-card .label { color: var(--text-secondary); font-size: 0.8rem; }
        .stat-card.online-card { border: 2px solid var(--success); background: rgba(92, 184, 92, 0.1); }
        .stat-card.online-card .number { color: var(--success); }
        
        /* Ø§Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙˆÙ† Ø­Ø§Ù„ÙŠØ§Ù‹ */
        .online-section { border: 2px solid var(--success) !important; background: rgba(92, 184, 92, 0.05) !important; }
        .online-section h3 { color: var(--success); }
        .online-section h3 svg { fill: none; stroke: var(--success); }
        .online-badge { background: var(--success); color: white; padding: 0.2rem 0.6rem; border-radius: 1rem; font-size: 0.8rem; margin-right: 0.5rem; animation: pulse 2s infinite; }
        .online-users-grid { display: flex; flex-wrap: wrap; gap: 0.75rem; min-height: 50px; }
        .online-user-card { display: flex; align-items: center; gap: 0.5rem; background: rgba(92, 184, 92, 0.15); border: 1px solid var(--success); padding: 0.6rem 0.9rem; border-radius: 0.75rem; min-width: 140px; }
        .online-user-avatar { width: 36px; height: 36px; background: var(--success); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 1rem; }
        .online-indicator { width: 10px; height: 10px; background: var(--success); border-radius: 50%; animation: pulse-dot 1.5s infinite; margin-right: auto; }
        @keyframes pulse-dot { 0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(92, 184, 92, 0.4); } 50% { opacity: 0.8; box-shadow: 0 0 0 8px rgba(92, 184, 92, 0); } }
        .online-user-info { display: flex; flex-direction: column; }
        .online-user-name { font-weight: 600; font-size: 0.85rem; color: var(--text-primary); }
        .online-user-time { font-size: 0.7rem; color: var(--text-secondary); }
        .empty-online { color: var(--text-secondary); font-size: 0.85rem; width: 100%; text-align: center; padding: 1rem; }
        
        /* Ø§Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙˆÙ† Ø­Ø§Ù„ÙŠØ§Ù‹ */
        .online-section { background: var(--bg-card); border-radius: 1rem; padding: 1.25rem; margin-bottom: 1.25rem; border: 1px solid var(--border); }
        .online-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; }
        .online-title { display: flex; align-items: center; gap: 0.5rem; font-family: 'Cairo', sans-serif; font-size: 1rem; }
        .online-count { background: var(--success); padding: 0.3rem 0.8rem; border-radius: 1rem; font-size: 0.85rem; font-weight: 600; animation: pulse 2s infinite; }
        .online-list { display: flex; flex-wrap: wrap; gap: 0.5rem; max-height: 200px; overflow-y: auto; }
        .online-user { display: flex; align-items: center; gap: 0.5rem; background: var(--bg-input); padding: 0.5rem 0.75rem; border-radius: 0.5rem; font-size: 0.85rem; }
        .online-dot { width: 8px; height: 8px; background: var(--success); border-radius: 50%; animation: blink 1.5s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        .online-user-name { font-weight: 600; }
        .online-user-time { font-size: 0.7rem; color: var(--text-secondary); }
        .stat-card.online-card { background: linear-gradient(135deg, rgba(92, 184, 92, 0.2), rgba(92, 184, 92, 0.1)); border: 1px solid rgba(92, 184, 92, 0.5); }
        .stat-card.online-card .number { color: #5cb85c; }
        
        .online-section { border: 1px solid rgba(92, 184, 92, 0.3); background: linear-gradient(135deg, rgba(92, 184, 92, 0.05), transparent); }
        .online-section h3 { color: #5cb85c; }
        .online-section h3 svg { width: 1.25rem; height: 1.25rem; margin-left: 0.5rem; }
        .online-badge { background: #5cb85c; color: white; padding: 0.2rem 0.6rem; border-radius: 1rem; font-size: 0.8rem; margin-right: 0.5rem; }
        .online-users-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 0.75rem; }
        .online-user-card { background: var(--bg-input); border-radius: 0.5rem; padding: 0.75rem; display: flex; align-items: center; gap: 0.75rem; border-right: 3px solid #5cb85c; }
        .online-user-avatar { width: 2.5rem; height: 2.5rem; background: var(--sec-orange); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1rem; }
        .online-user-info { flex: 1; }
        .online-user-name { font-weight: 600; font-size: 0.9rem; }
        .online-user-time { font-size: 0.7rem; color: var(--text-secondary); }
        .online-indicator { width: 10px; height: 10px; background: #5cb85c; border-radius: 50%; animation: pulse-online 2s infinite; }
        @keyframes pulse-online { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.2); } }
        .empty-online { text-align: center; padding: 2rem; color: var(--text-secondary); font-size: 0.9rem; }
        
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(18rem, 1fr)); gap: 0.875rem; margin-bottom: 1.25rem; }
        .chart-card { background: var(--bg-input); border-radius: 0.75rem; padding: 1rem; border: 1px solid var(--border); }
        .chart-card h4 { margin-bottom: 0.75rem; color: var(--sec-blue-pale); font-size: 0.9rem; }
        .chart-container { height: 12rem; position: relative; }
        
        .admin-section { background: var(--bg-card); border-radius: 1rem; padding: 1.25rem; margin-bottom: 1.25rem; border: 1px solid var(--border); }
        .admin-section h3 { font-family: 'Cairo', sans-serif; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; font-size: 1rem; }
        .admin-section h3 svg { width: 1.25rem; height: 1.25rem; fill: var(--sec-orange); }

        .toast-container { position: fixed; bottom: 1.25rem; left: 1.25rem; z-index: 2000; display: flex; flex-direction: column; gap: 0.5rem; }
        .toast { padding: 0.75rem 1rem; border-radius: 0.625rem; display: flex; align-items: center; gap: 0.625rem; box-shadow: var(--shadow); animation: fadeIn 0.3s; }
        .toast-success { background: var(--success); color: white; }
        .toast-error { background: var(--danger); color: white; }
        .toast-warning { background: var(--warning); color: #1a1a1a; }

        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(26, 54, 93, 0.8); display: none; align-items: center; justify-content: center; z-index: 3000; flex-direction: column; gap: 1rem; }
        .loading-overlay.active { display: flex; }
        .loading-spinner { width: 2.5rem; height: 2.5rem; border: 4px solid var(--border); border-top-color: var(--sec-orange); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner { width: 1.125rem; height: 1.125rem; border: 3px solid transparent; border-top-color: currentColor; border-radius: 50%; animation: spin 1s linear infinite; }

        @media (max-width: 768px) {
            .header { flex-direction: column; text-align: center; }
            .header-left { flex-direction: column; width: 100%; }
            .user-info, .logout-btn, .cache-status { width: 100%; justify-content: center; }
            .search-box { flex-direction: column; }
            .action-buttons { width: 100%; }
            .action-btn { flex: 1; justify-content: center; }
            .form-grid { grid-template-columns: 1fr; }
            .form-grid .form-group.full-width { grid-column: span 1; }
            .form-row { flex-direction: column; }
            .modal-footer { flex-direction: column; }
            .modal-footer .btn { width: 100%; }
            .fault-input-group { min-width: calc(50% - 0.375rem); }
        }
        @media (max-width: 480px) {
            .action-btn { font-size: 0.75rem; padding: 0.5rem 0.6rem; }
            .action-btn svg { width: 1rem; height: 1rem; }
            .action-btn span { font-size: 0.7rem; }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay"><div class="loading-spinner"></div><div>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div></div>
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ -->
    <div class="first-load-overlay" id="firstLoadOverlay">
        <div class="first-load-logo">âš¡</div>
        <div class="first-load-text">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø·Ø§Øª...</div>
        <div class="first-load-progress"><div class="first-load-bar" id="firstLoadBar"></div></div>
        <div class="first-load-count" id="firstLoadCount">0%</div>
        <div class="first-load-done" id="firstLoadDone">âœ“ ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!</div>
    </div>
    
    <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„Ø«Ø§Ø¨Øª -->
    <div class="install-btn" id="installBtn">
        <button class="close-install" onclick="hideInstallBanner(event)">Ã—</button>
        <svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
        <span onclick="installApp()">ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ</span>
    </div>
    
    <!-- iOS Install Prompt -->
    <div class="ios-install-prompt" id="iosInstallPrompt" style="display:none;">
        <div class="ios-prompt-content">
            <button class="ios-close" onclick="closeIOSPrompt()">Ã—</button>
            <div style="font-size:2rem;margin-bottom:0.5rem;">âš¡</div>
            <h4>ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</h4>
            <p>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ <svg viewBox="0 0 24 24" style="width:1.2rem;height:1.2rem;vertical-align:middle;fill:#5b8fb9;"><path d="M16 5l-1.42 1.42-1.59-1.59V16h-1.98V4.83L9.42 6.42 8 5l4-4 4 4zm4 5v11c0 1.1-.9 2-2 2H6c-1.11 0-2-.9-2-2V10c0-1.11.89-2 2-2h3v2H6v11h12V10h-3V8h3c1.1 0 2 .89 2 2z"/></svg> Ø«Ù… <strong>"Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"</strong></p>
        </div>
    </div>
    
    <style>
        .ios-install-prompt { position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-card); padding: 1.25rem; border-top-left-radius: 1rem; border-top-right-radius: 1rem; box-shadow: 0 -5px 20px rgba(0,0,0,0.3); z-index: 2000; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .ios-prompt-content { text-align: center; position: relative; }
        .ios-prompt-content h4 { margin: 0.5rem 0; color: var(--sec-orange); }
        .ios-prompt-content p { font-size: 0.85rem; color: var(--text-secondary); margin: 0; }
        .ios-close { position: absolute; top: -0.5rem; left: 0; background: none; border: none; font-size: 1.5rem; color: var(--text-secondary); cursor: pointer; }
    </style>

    <!-- Login -->
    <div class="page active" id="loginPage">
        <div class="login-container">
            <div class="login-card">
                <div class="logo-section">
                    <div class="logo-icon">âš¡</div>
                    <h1>Ù†Ø¸Ø§Ù… Ù…Ø­Ø·Ø§Øª SEC</h1>
                    <p>Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© Ù„Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡ - Ø¬Ø¯Ø©</p>
                </div>
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('login')">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</div>
                    <div class="tab" onclick="switchTab('register')">Ù…Ø´ØªØ±Ùƒ Ø¬Ø¯ÙŠØ¯</div>
                </div>
                <div class="tab-content active" id="loginTab">
                    <form onsubmit="return handleLogin(event)">
                        <div class="form-group">
                            <label>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
                            <input type="tel" id="loginPhone" placeholder="05xxxxxxxx" maxlength="10" oninput="validateLoginPhone()" required>
                            <div class="input-hint" id="loginPhoneHint">Ø£Ø¯Ø®Ù„ 10 Ø£Ø±Ù‚Ø§Ù… ØªØ¨Ø¯Ø£ Ø¨Ù€ 05</div>
                        </div>
                        <button type="submit" class="btn btn-primary" id="loginBtn" disabled>Ø¯Ø®ÙˆÙ„</button>
                    </form>
                </div>
                <div class="tab-content" id="registerTab">
                    <form onsubmit="return handleRegister(event)">
                        <div class="form-group"><label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ *</label><input type="text" id="regName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ" oninput="validateRegPhone()" required></div>
                        <div class="form-row">
                            <div class="form-group"><label>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ *</label><input type="tel" id="regPhone" placeholder="05xxxxxxxx" maxlength="10" oninput="validateRegPhone()" required><div class="input-hint" id="regPhoneHint">10 Ø£Ø±Ù‚Ø§Ù…</div></div>
                            <div class="form-group"><label>Ø§Ù„Ù†ÙˆØ¹</label><select id="regType"><option value="Ù…ÙˆØ¸Ù">Ù…ÙˆØ¸Ù</option><option value="Ù…Ù‚Ø§ÙˆÙ„">Ù…Ù‚Ø§ÙˆÙ„</option></select></div>
                        </div>
                        <div class="form-group"><label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label><input type="email" id="regEmail" placeholder="example@email.com"></div>
                        <button type="submit" class="btn btn-success" id="regBtn" disabled>ØªØ³Ø¬ÙŠÙ„</button>
                    </form>
                </div>
                <div class="admin-link"><a href="#" onclick="showAdminLogin()">ğŸ” Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙŠØ±</a></div>
            </div>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div class="modal-overlay" id="adminLoginModal">
        <div class="modal">
            <div class="modal-header"><h3>ğŸ” Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙŠØ±</h3><button class="modal-close" onclick="closeModal('adminLoginModal')"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg></button></div>
            <div class="modal-body">
                <div class="form-group"><label>Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„</label>
                    <div class="password-wrapper">
                        <input type="password" id="adminCode" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„Ù…Ø¯ÙŠØ±">
                        <button type="button" class="password-toggle" onclick="togglePassword()"><svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg></button>
                    </div>
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('adminLoginModal')">Ø¥Ù„ØºØ§Ø¡</button><button class="btn btn-primary" onclick="adminLogin()">Ø¯Ø®ÙˆÙ„</button></div>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="page" id="dashboardPage">
        <div class="dashboard-container">
            <header class="header">
                <div class="header-right">
                    <div class="header-logo">âš¡</div>
                    <div><div class="header-title">Ù†Ø¸Ø§Ù… Ù…Ø­Ø·Ø§Øª SEC</div><div class="header-subtitle">Ø¬Ø¯Ø©</div></div>
                </div>
                <div class="header-left">
                    <button class="whatsapp-btn" onclick="openWhatsApp()" title="ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§ Ø¹Ø¨Ø± Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨">
                        <svg viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                    </button>
                    <div class="cache-status" id="cacheStatus" onclick="manualRefreshCache()"><span>ğŸ“¦</span><span class="cache-text" id="cacheText">ØªØ­Ù…ÙŠÙ„...</span></div>
                    <div class="user-info"><div class="user-avatar" id="userAvatar">Ù…</div><div><div class="user-name" id="userName">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</div><div class="user-type" id="userType">Ù…ÙˆØ¸Ù</div></div></div>
                    <button class="logout-btn" onclick="logout()"><svg viewBox="0 0 24 24"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg><span>Ø®Ø±ÙˆØ¬</span></button>
                </div>
            </header>

            <section class="search-section">
                <div class="search-header"><svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg><h2>Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø­Ø·Ø©</h2></div>
                <div class="search-box">
                    <div class="search-input-wrapper"><input type="text" id="searchInput" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…Ø­Ø·Ø© Ø£Ùˆ Ø§Ø®ØªØµØ§Ø± Ø§Ù„ØªØ­ÙˆÙŠÙ„..." onkeypress="if(event.key==='Enter')searchStation()"></div>
                    <div class="action-buttons">
                        <button class="action-btn btn-search" onclick="searchStation()"><svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg><span>Ø¨Ø­Ø«</span></button>
                        <button class="action-btn btn-add" onclick="openAddModal('distribution')"><svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg><span>ØªÙˆØ²ÙŠØ¹</span></button>
                        <button class="action-btn btn-add-sub" onclick="openAddModal('substation')"><svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg><span>ØªØ­ÙˆÙŠÙ„</span></button>
                        <button class="action-btn btn-fault" onclick="openFaultModal()"><svg viewBox="0 0 24 24"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg><span>Ø£Ø¹Ø·Ø§Ù„</span></button>
                    </div>
                </div>
            </section>

            <section class="results-section">
                <div class="results-header"><div class="results-title"><svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/></svg><h3>Ø§Ù„Ù†ØªØ§Ø¦Ø¬</h3></div><div class="results-count" id="resultsCount">0</div></div>
                <div id="resultsContent"><div class="empty-state"><svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5z"/></svg><h4>Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…Ø­Ø·Ø© Ù„Ù„Ø¨Ø­Ø«</h4></div></div>
            </section>

            <section class="map-section" id="mapSection" style="display:none;">
                <div class="results-header"><div class="results-title"><svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/></svg><h3>Ø§Ù„Ù…Ø­Ø·Ø§Øª Ø§Ù„Ù‚Ø±ÙŠØ¨Ø© (3.5 ÙƒÙ…)</h3></div><div class="results-count" id="nearbyCount">0</div></div>
                <div class="map-container"><div id="nearbyMap"></div></div>
                <div class="nearby-list" id="nearbyList"></div>
            </section>
        </div>
    </div>

    <!-- Add Distribution Modal -->
    <div class="modal-overlay" id="addDistributionModal">
        <div class="modal">
            <div class="modal-header"><h3><svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ø·Ø© ØªÙˆØ²ÙŠØ¹</h3><button class="modal-close" onclick="closeModal('addDistributionModal')"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg></button></div>
            <div class="modal-body">
                <div class="form-grid">
                    <div class="form-group"><label>Ø±Ù‚Ù… Ø§Ù„Ù…Ø­Ø·Ø© *</label><input type="text" id="addDistNumber" placeholder="41475" required></div>
                    <div class="form-group"><label>Ø§Ù„Ù…ØºØ°ÙŠ</label><input type="text" id="addDistFeeder" placeholder="MDN2-17"></div>
                    <div class="form-group full-width"><label>Ø§Ù„Ø­ÙŠ *</label><input type="text" id="addDistRegion" required></div>
                    <div class="form-group"><label>Ø®Ø· Ø§Ù„Ø¹Ø±Ø¶</label><input type="text" id="addDistLat" readonly placeholder="ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø£Ùˆ ÙŠØ¯ÙˆÙŠ"></div>
                    <div class="form-group"><label>Ø®Ø· Ø§Ù„Ø·ÙˆÙ„</label><input type="text" id="addDistLng" readonly placeholder="ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø£Ùˆ ÙŠØ¯ÙˆÙŠ"></div>
                    <div class="form-group full-width">
                        <button type="button" class="location-btn" id="addDistLocationBtn" onclick="getCurrentLocation('addDist')"><svg viewBox="0 0 24 24"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06z"/></svg><span>ğŸ“ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ (GPS)</span></button>
                        <div class="coords-or">â€” Ø£Ùˆ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª ÙŠØ¯ÙˆÙŠØ§Ù‹ â€”</div>
                        <div class="coords-manual-input">
                            <input type="text" id="addDistCoordsManual" placeholder="21.5234,39.1876" dir="ltr">
                            <button type="button" class="parse-btn" onclick="parseManualCoords('addDist')">ØªØ·Ø¨ÙŠÙ‚</button>
                        </div>
                        <div class="coords-hint">Ø§Ù„ØµÙŠØºØ©: Ø®Ø· Ø§Ù„Ø¹Ø±Ø¶,Ø®Ø· Ø§Ù„Ø·ÙˆÙ„ (Ù…Ø«Ø§Ù„: 21.5234,39.1876)</div>
                    </div>
                    <div class="form-group full-width"><label>Ø§Ù„Ø³Ø¨Ø¨</label><textarea id="addDistReason"></textarea></div>
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('addDistributionModal')">Ø¥Ù„ØºØ§Ø¡</button><button class="btn btn-success" onclick="submitAddDistribution()">Ø­ÙØ¸</button></div>
        </div>
    </div>

    <!-- Add Substation Modal -->
    <div class="modal-overlay" id="addSubstationModal">
        <div class="modal">
            <div class="modal-header"><h3><svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ø·Ø© ØªØ­ÙˆÙŠÙ„</h3><button class="modal-close" onclick="closeModal('addSubstationModal')"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg></button></div>
            <div class="modal-body">
                <div class="form-grid">
                    <div class="form-group full-width"><label>Ø§Ø®ØªØµØ§Ø± Ø§Ù„Ù…Ø­Ø·Ø© *</label><input type="text" id="addSubShortName" placeholder="MDN Ø£Ùˆ IC5" required></div>
                    <div class="form-group"><label>Ø®Ø· Ø§Ù„Ø¹Ø±Ø¶</label><input type="text" id="addSubLat" readonly placeholder="ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø£Ùˆ ÙŠØ¯ÙˆÙŠ"></div>
                    <div class="form-group"><label>Ø®Ø· Ø§Ù„Ø·ÙˆÙ„</label><input type="text" id="addSubLng" readonly placeholder="ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø£Ùˆ ÙŠØ¯ÙˆÙŠ"></div>
                    <div class="form-group full-width">
                        <button type="button" class="location-btn" id="addSubLocationBtn" onclick="getCurrentLocation('addSub')"><svg viewBox="0 0 24 24"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06z"/></svg><span>ğŸ“ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ (GPS)</span></button>
                        <div class="coords-or">â€” Ø£Ùˆ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª ÙŠØ¯ÙˆÙŠØ§Ù‹ â€”</div>
                        <div class="coords-manual-input">
                            <input type="text" id="addSubCoordsManual" placeholder="21.5234,39.1876" dir="ltr">
                            <button type="button" class="parse-btn" onclick="parseManualCoords('addSub')">ØªØ·Ø¨ÙŠÙ‚</button>
                        </div>
                        <div class="coords-hint">Ø§Ù„ØµÙŠØºØ©: Ø®Ø· Ø§Ù„Ø¹Ø±Ø¶,Ø®Ø· Ø§Ù„Ø·ÙˆÙ„ (Ù…Ø«Ø§Ù„: 21.5234,39.1876)</div>
                    </div>
                    <div class="form-group full-width"><label>Ø§Ù„Ø³Ø¨Ø¨</label><textarea id="addSubReason"></textarea></div>
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('addSubstationModal')">Ø¥Ù„ØºØ§Ø¡</button><button class="btn btn-success" onclick="submitAddSubstation()">Ø­ÙØ¸</button></div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal-overlay" id="editModal">
        <div class="modal">
            <div class="modal-header"><h3><svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z"/></svg>ØªØ¹Ø¯ÙŠÙ„ Ù…Ø­Ø·Ø©</h3><button class="modal-close" onclick="closeModal('editModal')"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg></button></div>
            <div class="modal-body">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label>Ø±Ù‚Ù… Ø§Ù„Ù…Ø­Ø·Ø©</label>
                        <input type="text" id="editStationNumber" readonly style="background: var(--bg-dark); cursor: not-allowed; opacity: 0.7;">
                        <div class="input-hint">ğŸ”’ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø±Ù‚Ù… Ø§Ù„Ù…Ø­Ø·Ø©</div>
                    </div>
                    <div class="form-group" id="editFeederGroup"><label>Ø§Ù„Ù…ØºØ°ÙŠ</label><input type="text" id="editFeeder"></div>
                    <div class="form-group" id="editRegionGroup"><label>Ø§Ù„Ø­ÙŠ</label><input type="text" id="editRegion"></div>
                    <div class="form-group"><label>Ø®Ø· Ø§Ù„Ø¹Ø±Ø¶</label><input type="text" id="editLatitude" placeholder="ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø£Ùˆ ÙŠØ¯ÙˆÙŠ"></div>
                    <div class="form-group"><label>Ø®Ø· Ø§Ù„Ø·ÙˆÙ„</label><input type="text" id="editLongitude" placeholder="ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø£Ùˆ ÙŠØ¯ÙˆÙŠ"></div>
                    <div class="form-group full-width">
                        <button type="button" class="location-btn" id="editLocationBtn" onclick="getCurrentLocation('edit')"><svg viewBox="0 0 24 24"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4z"/></svg><span>ğŸ“ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ (GPS)</span></button>
                        <div class="coords-or">â€” Ø£Ùˆ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª ÙŠØ¯ÙˆÙŠØ§Ù‹ â€”</div>
                        <div class="coords-manual-input">
                            <input type="text" id="editCoordsManual" placeholder="21.5234,39.1876" dir="ltr">
                            <button type="button" class="parse-btn" onclick="parseManualCoords('edit')">ØªØ·Ø¨ÙŠÙ‚</button>
                        </div>
                        <div class="coords-hint">Ø§Ù„ØµÙŠØºØ©: Ø®Ø· Ø§Ù„Ø¹Ø±Ø¶,Ø®Ø· Ø§Ù„Ø·ÙˆÙ„ (Ù…Ø«Ø§Ù„: 21.5234,39.1876)</div>
                    </div>
                    <div class="form-group full-width"><label>Ø§Ù„Ø³Ø¨Ø¨</label><textarea id="editReason" placeholder="Ø³Ø¨Ø¨ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea></div>
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('editModal')">Ø¥Ù„ØºØ§Ø¡</button><button class="btn btn-warning" onclick="submitEdit()">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button></div>
        </div>
    </div>

    <!-- Fault Modal -->
    <div class="modal-overlay" id="faultModal">
        <div class="modal" style="max-width:42rem;">
            <div class="modal-header"><h3><svg viewBox="0 0 24 24"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>ØªØªØ¨Ø¹ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„</h3><button class="modal-close" onclick="closeModal('faultModal')"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg></button></div>
            <div class="modal-body">
                <p style="margin-bottom:1rem;color:var(--text-secondary);font-size:0.85rem;">Ø£Ø¯Ø®Ù„ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø­Ø·Ø§Øª (2-6)</p>
                <div class="fault-inputs">
                    <div class="fault-input-row">
                        <div class="fault-input-group"><label>1</label><input type="text" id="fault1"></div>
                        <div class="fault-input-group"><label>2</label><input type="text" id="fault2"></div>
                        <div class="fault-input-group"><label>3</label><input type="text" id="fault3"></div>
                    </div>
                    <div class="fault-input-row">
                        <div class="fault-input-group"><label>4</label><input type="text" id="fault4"></div>
                        <div class="fault-input-group"><label>5</label><input type="text" id="fault5"></div>
                        <div class="fault-input-group"><label>6</label><input type="text" id="fault6"></div>
                    </div>
                </div>
                <button class="btn btn-primary" style="margin-top:1rem;" onclick="searchFaultStations()"><svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5z"/></svg>Ø¨Ø­Ø«</button>
                <div id="faultResults" style="display:none;margin-top:1.25rem;">
                    <div class="results-header"><div class="results-title"><h3>Ù…Ø­Ø·Ø§Øª Ø§Ù„Ø¹Ø·Ù„</h3></div><div class="results-count" id="faultCount">0</div></div>
                    <div id="totalDistance" style="text-align:center;margin:0.75rem 0;"></div>
                    <div class="results-table-wrapper" style="max-height:10rem;overflow-y:auto;"><table class="results-table"><thead><tr><th>#</th><th>Ø§Ù„Ù…Ø­Ø·Ø©</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead><tbody id="faultTableBody"></tbody></table></div>
                    <div class="map-container" style="height:14rem;margin-top:1rem;"><div id="faultMap"></div></div>
                    <a id="faultNavigationLink" href="#" target="_blank" class="btn btn-success" style="margin-top:1rem;text-decoration:none;"><svg viewBox="0 0 24 24"><path d="M21.71 11.29l-9-9c-.39-.39-1.02-.39-1.41 0l-9 9c-.39.39-.39 1.02 0 1.41l9 9c.39.39 1.02.39 1.41 0l9-9c.39-.38.39-1.01 0-1.41z"/></svg>ÙØªØ­ Ø§Ù„ØªÙ†Ù‚Ù„</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Page -->
    <div class="page" id="adminPage">
        <div class="dashboard-container">
            <header class="header">
                <div class="header-right"><div class="header-logo">âš¡</div><div><div class="header-title">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±</div><div class="header-subtitle">SEC Ø¬Ø¯Ø©</div></div></div>
                <div class="header-left"><button class="logout-btn" onclick="logout()"><svg viewBox="0 0 24 24"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5z"/></svg><span>Ø®Ø±ÙˆØ¬</span></button></div>
            </header>
            <div class="stats-grid">
                <div class="stat-card"><div class="number" id="totalDistribution">0</div><div class="label">ØªÙˆØ²ÙŠØ¹</div></div>
                <div class="stat-card"><div class="number" id="totalSubstations">0</div><div class="label">ØªØ­ÙˆÙŠÙ„</div></div>
                <div class="stat-card"><div class="number" id="totalUsers">0</div><div class="label">Ù…Ø´ØªØ±ÙƒÙŠÙ†</div></div>
                <div class="stat-card"><div class="number" id="totalAdditions">0</div><div class="label">Ø¥Ø¶Ø§ÙØ§Øª</div></div>
                <div class="stat-card"><div class="number" id="totalEdits">0</div><div class="label">ØªØ¹Ø¯ÙŠÙ„Ø§Øª</div></div>
                <div class="stat-card online-card"><div class="number" id="onlineCount">0</div><div class="label">ğŸŸ¢ Ù…ØªÙˆØ§Ø¬Ø¯ÙˆÙ† Ø§Ù„Ø¢Ù†</div></div>
            </div>
            
            <!-- Ù‚Ø³Ù… Ø§Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹ -->
            <section class="admin-section online-section">
                <h3><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/><circle cx="12" cy="12" r="4" fill="#5cb85c"/></svg>Ø§Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙˆÙ† Ø§Ù„Ø¢Ù† <span class="online-badge" id="onlineBadge">0</span></h3>
                <div class="online-users-grid" id="onlineUsersList">
                    <div class="empty-online">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØªÙˆØ§Ø¬Ø¯ÙˆÙ† Ø­Ø§Ù„ÙŠØ§Ù‹</div>
                </div>
            </section>
            <div class="charts-grid">
                <div class="chart-card"><h4>ğŸ“Š Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</h4><div class="chart-container"><canvas id="visitsChart"></canvas></div></div>
                <div class="chart-card"><h4>ğŸ“ˆ Ø§Ù„Ù†Ø´Ø§Ø·</h4><div class="chart-container"><canvas id="activityChart"></canvas></div></div>
            </div>
            <section class="admin-section"><h3>ğŸ‘¥ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</h3><div class="results-table-wrapper"><table class="results-table"><thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¬ÙˆØ§Ù„</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ØªØ³Ø¬ÙŠÙ„</th></tr></thead><tbody id="adminUsersBody"></tbody></table></div></section>
            <section class="admin-section"><h3>ğŸ“‹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</h3><div class="results-table-wrapper"><table class="results-table"><thead><tr><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ø­Ø·Ø©</th><th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr></thead><tbody id="adminLogsBody"></tbody></table></div></section>
        </div>
    </div>

    <script>
        const API_URL = 'Ø¶Ø¹_Ø±Ø§Ø¨Ø·_Ø§Ù„Ù€_API_Ù‡Ù†Ø§';
        let currentUser = null, nearbyMap = null, faultMap = null, faultStations = [], editingStationType = null, deferredPrompt = null;
        const CACHE_KEY = 'sec_stations_v7', CACHE_VERSION_KEY = 'sec_version_v7';
        let allStations = [], isStationsLoaded = false, versionCheckTimer = null, currentVersion = null;
        let onlineUpdateTimer = null; // Ù…Ø¤Ù‚Øª ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙŠÙ†
        let contactPhone = '966500000000'; // Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„ Ø¹Ø¨Ø± Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨

        // Cache
        function startVersionCheck() { if (versionCheckTimer) clearInterval(versionCheckTimer); versionCheckTimer = setInterval(checkForUpdates, 30000); }
        function stopVersionCheck() { if (versionCheckTimer) { clearInterval(versionCheckTimer); versionCheckTimer = null; } }
        
        async function checkForUpdates() { try { const r = await apiGet('getVersion'); if (r.version && r.version !== currentVersion) { await silentRefreshCache(); currentVersion = r.version; localStorage.setItem(CACHE_VERSION_KEY, currentVersion); showToast('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« ğŸ”„'); } } catch (e) {} }
        async function silentRefreshCache() { try { const r = await apiGet('getAllStations'); if (r.stations?.length) { allStations = r.stations; isStationsLoaded = true; localStorage.setItem(CACHE_KEY, JSON.stringify(allStations)); updateCacheStatus('loaded', allStations.length.toLocaleString('ar-SA') + ' Ù…Ø­Ø·Ø© âœ“'); } } catch (e) {} }
        async function loadStationsCache() { 
            updateCacheStatus('loading', 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...'); 
            currentVersion = localStorage.getItem(CACHE_VERSION_KEY); 
            const c = localStorage.getItem(CACHE_KEY); 
            if (c && currentVersion) { 
                allStations = JSON.parse(c); 
                isStationsLoaded = true; 
                updateCacheStatus('loaded', allStations.length.toLocaleString('ar-SA') + ' Ù…Ø­Ø·Ø© âœ“'); 
                startVersionCheck(); 
                checkForUpdates(); 
                return; 
            } 
            await refreshStationsCacheWithProgress(); 
        }
        
        async function refreshStationsCacheWithProgress() {
            const overlay = document.getElementById('firstLoadOverlay');
            const bar = document.getElementById('firstLoadBar');
            const countEl = document.getElementById('firstLoadCount');
            const doneEl = document.getElementById('firstLoadDone');
            
            overlay.classList.add('active');
            bar.style.width = '10%';
            countEl.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...';
            
            try {
                bar.style.width = '30%';
                countEl.textContent = 'Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...';
                
                const [versionResult, stationsResult] = await Promise.all([
                    apiGet('getVersion'), 
                    apiGet('getAllStations')
                ]);
                
                bar.style.width = '70%';
                countEl.textContent = 'Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...';
                
                if (stationsResult.stations && stationsResult.stations.length > 0) {
                    allStations = stationsResult.stations;
                    isStationsLoaded = true;
                    currentVersion = versionResult.version || Date.now().toString();
                    
                    bar.style.width = '90%';
                    countEl.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
                    
                    localStorage.setItem(CACHE_KEY, JSON.stringify(allStations));
                    localStorage.setItem(CACHE_VERSION_KEY, currentVersion);
                    
                    bar.style.width = '100%';
                    countEl.textContent = allStations.length.toLocaleString('ar-SA') + ' Ù…Ø­Ø·Ø©';
                    doneEl.classList.add('show');
                    
                    updateCacheStatus('loaded', allStations.length.toLocaleString('ar-SA') + ' Ù…Ø­Ø·Ø© âœ“');
                    
                    setTimeout(() => {
                        overlay.classList.remove('active');
                        showToast('ØªÙ… ØªØ­Ù…ÙŠÙ„ ' + allStations.length.toLocaleString('ar-SA') + ' Ù…Ø­Ø·Ø© âœ“', 'success');
                    }, 1500);
                    
                    startVersionCheck();
                } else {
                    throw new Error('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª');
                }
            } catch (e) {
                bar.style.width = '100%';
                bar.style.background = 'var(--danger)';
                countEl.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ - ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„';
                updateCacheStatus('error', 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ âŒ');
                
                setTimeout(() => {
                    overlay.classList.remove('active');
                    showToast('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                }, 2000);
            }
        }
        
        async function refreshStationsCache() { 
            try { 
                updateCacheStatus('loading', 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...'); 
                const [v, s] = await Promise.all([apiGet('getVersion'), apiGet('getAllStations')]); 
                if (s.stations?.length) { 
                    allStations = s.stations; 
                    isStationsLoaded = true; 
                    currentVersion = v.version || Date.now().toString(); 
                    localStorage.setItem(CACHE_KEY, JSON.stringify(allStations)); 
                    localStorage.setItem(CACHE_VERSION_KEY, currentVersion); 
                    updateCacheStatus('loaded', allStations.length.toLocaleString('ar-SA') + ' Ù…Ø­Ø·Ø© âœ“'); 
                    startVersionCheck(); 
                } else {
                    updateCacheStatus('error', 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ âŒ');
                }
            } catch (e) { 
                updateCacheStatus('error', 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ âŒ'); 
            } 
        }
        function clearStationsCache() { localStorage.removeItem(CACHE_KEY); localStorage.removeItem(CACHE_VERSION_KEY); isStationsLoaded = false; allStations = []; currentVersion = null; }
        async function manualRefreshCache() { clearStationsCache(); await refreshStationsCache(); showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª âœ“'); }
        function updateCacheStatus(s, t) { const el = document.getElementById('cacheStatus'), txt = document.getElementById('cacheText'); if (el && txt) { el.className = 'cache-status ' + s; txt.textContent = t; } }
        // ØªÙ†Ø¸ÙŠÙ Ø§Ø³Ù… Ù…Ø­Ø·Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„ - Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø£Ø­Ø±Ù Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ÙˆØ§Ù„Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·
        function cleanSubstationName(name) {
            if (!name) return '';
            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø£ÙˆÙ„ ÙÙ‚Ø· (Ù‚Ø¨Ù„ Ø£ÙŠ - Ø£Ùˆ . Ø£Ùˆ Ø±Ù…ÙˆØ² Ø£Ø®Ø±Ù‰)
            let cleaned = String(name).split(/[-.]/).shift() || '';
            // Ø¥Ø²Ø§Ù„Ø© ÙƒÙ„ Ø´ÙŠØ¡ Ù…Ø§ Ø¹Ø¯Ø§ Ø§Ù„Ø£Ø­Ø±Ù Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ÙˆØ§Ù„Ø£Ø±Ù‚Ø§Ù…
            cleaned = cleaned.replace(/[^a-zA-Z0-9]/g, '');
            // ØªØ­ÙˆÙŠÙ„ Ù„Ù„Ø£Ø­Ø±Ù Ø§Ù„ÙƒØ¨ÙŠØ±Ø©
            return cleaned.toUpperCase();
        }
        
        // ØªØ·Ø¨ÙŠØ¹ Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ø·Ø© Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø© (Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§ÙØ§Øª)
        function normalizeStationName(name) {
            if (!name) return '';
            return String(name).replace(/\s+/g, '').toUpperCase();
        }
        
        // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø­Ù„ÙŠ Ø§Ù„Ù…Ø­Ø³Ù‘Ù†
        function searchStationLocal(n) { 
            if (!n) return { found: false }; 
            let searchValue = String(n).trim();
            
            // 1. Ø§Ù„Ø¨Ø­Ø« Ø£ÙˆÙ„Ø§Ù‹ Ø¨Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© (Ù„Ù„ØªÙˆØ²ÙŠØ¹ - Ø£Ø±Ù‚Ø§Ù…)
            let station = allStations.find(x => 
                String(x.number).toUpperCase() === searchValue.toUpperCase()
            );
            
            if (station) return { found: true, station: station };
            
            // 2. Ø§Ù„Ø¨Ø­Ø« Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ†Ø¸ÙŠÙ (Ù„Ù…Ø­Ø·Ø§Øª Ø§Ù„ØªØ­ÙˆÙŠÙ„)
            const cleanedSearch = cleanSubstationName(searchValue);
            
            if (cleanedSearch) {
                // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ù…Ø­Ø·Ø§Øª Ø§Ù„ØªØ­ÙˆÙŠÙ„
                station = allStations.find(x => {
                    if (x.type === 'substation') {
                        // Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ø¯ÙˆÙ† Ù…Ø³Ø§ÙØ§Øª
                        const cleanedNumber = normalizeStationName(x.number);
                        const normalizedSearch = normalizeStationName(cleanedSearch);
                        
                        // MDN2 = MDN 2 = MDN2
                        if (cleanedNumber === normalizedSearch) return true;
                        
                        // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¬Ø²Ø¦ÙŠ: MDN2-06 ÙŠØ¬Ø¯ MDN2
                        const cleanedStationName = cleanSubstationName(x.number);
                        if (cleanedStationName === cleanedSearch) return true;
                    }
                    return false;
                });
                
                if (station) return { found: true, station: station };
                
                // 3. Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø­Ø±ÙˆÙ ÙˆØ§Ù„Ø£Ø±Ù‚Ø§Ù…
                // MDN2 -> MDN 2
                const withSpace = cleanedSearch.replace(/([A-Z]+)(\d+)/i, '$1 $2');
                station = allStations.find(x => {
                    if (x.type === 'substation') {
                        return String(x.number).toUpperCase() === withSpace ||
                               normalizeStationName(x.number) === normalizeStationName(withSpace);
                    }
                    return false;
                });
            }
            
            return station ? { found: true, station: station } : { found: false }; 
        }
        function getNearbyStationsLocal(lat, lng, r = 3.5) { if (!lat || !lng) return []; const cLat = parseFloat(lat), cLng = parseFloat(lng); return allStations.filter(s => { if (!s.lat || !s.lng) return false; const d = calcDistance(cLat, cLng, parseFloat(s.lat), parseFloat(s.lng)); s.distance = d.toFixed(2); return d <= r; }).sort((a, b) => parseFloat(a.distance) - parseFloat(b.distance)); }
        function calcDistance(lat1, lon1, lat2, lon2) { const R = 6371, dLat = (lat2 - lat1) * Math.PI / 180, dLon = (lon2 - lon1) * Math.PI / 180, a = Math.sin(dLat/2)**2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2)**2; return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); }

        // Helpers
        function showLoading(t = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...') { document.getElementById('loadingOverlay').classList.add('active'); }
        function hideLoading() { document.getElementById('loadingOverlay').classList.remove('active'); }
        async function apiGet(action, params = {}) { 
            try {
                const url = new URL(API_URL); 
                url.searchParams.append('action', action); 
                Object.keys(params).forEach(k => url.searchParams.append(k, params[k])); 
                return (await fetch(url)).json(); 
            } catch (e) {
                console.error('API Error:', e);
                return { error: 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…' };
            }
        }
        async function apiPost(data) { 
            try {
                return (await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(data) })).json(); 
            } catch (e) {
                console.error('API Error:', e);
                return { error: 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…' };
            }
        }
        function showPage(id) { document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function showToast(msg, type = 'success') { const c = document.getElementById('toastContainer'), t = document.createElement('div'); t.className = `toast toast-${type}`; t.innerHTML = msg; c.appendChild(t); setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 300); }, 3000); }
        function togglePassword() { const i = document.getElementById('adminCode'); i.type = i.type === 'password' ? 'text' : 'password'; }
        
        // WhatsApp - Ø§Ù„ØªÙˆØ§ØµÙ„ Ø¹Ø¨Ø± Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨
        async function loadContactPhone() {
            try {
                const r = await apiGet('getContactNumber');
                if (r.phone) {
                    contactPhone = r.phone;
                }
            } catch (e) {
                console.log('Error loading contact phone');
            }
        }
        
        function openWhatsApp() {
            // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø±Ù‚Ù…
            let phone = contactPhone.replace(/\D/g, '');
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 0ØŒ Ø§Ø³ØªØ¨Ø¯Ù„Ù‡ Ø¨Ù€ 966
            if (phone.startsWith('0')) {
                phone = '966' + phone.substring(1);
            }
            
            // Ø¥Ø°Ø§ Ù„Ù… ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 966ØŒ Ø£Ø¶ÙÙ‡Ø§
            if (!phone.startsWith('966')) {
                phone = '966' + phone;
            }
            
            // Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨ÙŠØ©
            const message = encodeURIComponent('Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ…ØŒ Ø£ØªÙˆØ§ØµÙ„ Ù…Ø¹ÙƒÙ… Ù…Ù† Ù†Ø¸Ø§Ù… Ù…Ø­Ø·Ø§Øª SEC');
            
            // ÙØªØ­ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨
            window.open(`https://wa.me/${phone}?text=${message}`, '_blank');
        }

        // ============================================
        // Ù†Ø¸Ø§Ù… ØªØªØ¨Ø¹ Ø§Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙŠÙ†
        // ============================================
        function startOnlineTracking() {
            if (!currentUser) return;
            
            // ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ
            updateMyOnlineStatus();
            
            // ØªØ­Ø¯ÙŠØ« ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
            if (onlineUpdateTimer) clearInterval(onlineUpdateTimer);
            onlineUpdateTimer = setInterval(updateMyOnlineStatus, 30000);
            
            // Ø¹Ù†Ø¯ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØµÙØ­Ø©
            window.addEventListener('beforeunload', setMeOffline);
        }
        
        function stopOnlineTracking() {
            if (onlineUpdateTimer) {
                clearInterval(onlineUpdateTimer);
                onlineUpdateTimer = null;
            }
            setMeOffline();
        }
        
        async function updateMyOnlineStatus() {
            if (!currentUser) return;
            try {
                await apiPost({ 
                    action: 'updateOnline', 
                    phone: currentUser.phone, 
                    name: currentUser.name 
                });
            } catch (e) {
                console.log('ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„');
            }
        }
        
        function setMeOffline() {
            if (!currentUser) return;
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… sendBeacon Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
            const data = JSON.stringify({ action: 'userOffline', phone: currentUser.phone });
            if (navigator.sendBeacon) {
                navigator.sendBeacon(API_URL, data);
            }
        }
        
        async function loadOnlineUsers() {
            try {
                const result = await apiGet('getOnlineUsers');
                if (result.success) {
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
                    const countEl = document.getElementById('onlineCount');
                    const badgeEl = document.getElementById('onlineBadge');
                    if (countEl) countEl.textContent = result.count || 0;
                    if (badgeEl) badgeEl.textContent = result.count || 0;
                    
                    // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙŠÙ†
                    const listEl = document.getElementById('onlineUsersList');
                    if (listEl) {
                        if (result.users && result.users.length > 0) {
                            listEl.innerHTML = result.users.map(u => {
                                const timeParts = u.lastActive ? u.lastActive.split(' ')[1] : '';
                                return `<div class="online-user-card">
                                    <div class="online-dot"></div>
                                    <div class="online-user-info">
                                        <span class="online-user-name">${u.name || 'Ù…Ø³ØªØ®Ø¯Ù…'}</span>
                                        <span class="online-user-time">Ø¢Ø®Ø± Ù†Ø´Ø§Ø·: ${timeParts || 'Ø§Ù„Ø¢Ù†'}</span>
                                    </div>
                                </div>`;
                            }).join('');
                        } else {
                            listEl.innerHTML = '<div class="empty-online">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØªÙˆØ§Ø¬Ø¯ÙˆÙ† Ø­Ø§Ù„ÙŠØ§Ù‹</div>';
                        }
                    }
                }
            } catch (e) {
                console.log('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙŠÙ†');
            }
        }

        // PWA
        window.addEventListener('beforeinstallprompt', e => { e.preventDefault(); deferredPrompt = e; showInstallBanner(); });
        
        function showInstallBanner() {
            const btn = document.getElementById('installBtn');
            if (!localStorage.getItem('installBannerClosed')) {
                btn.classList.add('show');
                document.body.classList.add('install-visible');
            }
        }
        
        function hideInstallBanner(e) {
            if (e) e.stopPropagation();
            const btn = document.getElementById('installBtn');
            btn.classList.remove('show');
            document.body.classList.remove('install-visible');
            localStorage.setItem('installBannerClosed', 'true');
        }
        
        function installApp() { 
            if (deferredPrompt) { 
                deferredPrompt.prompt(); 
                deferredPrompt.userChoice.then(c => { 
                    if (c.outcome === 'accepted') hideInstallBanner(); 
                    deferredPrompt = null; 
                }); 
            } else {
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                if (isIOS) {
                    document.getElementById('iosInstallPrompt').style.display = 'block';
                } else {
                    showToast('Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ â‹® Ø«Ù… "ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚"', 'warning');
                }
            }
        }
        
        function checkIOSInstall() {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isStandalone = window.navigator.standalone === true;
            
            if (isIOS && !isStandalone && !localStorage.getItem('iosPromptShown')) {
                setTimeout(() => {
                    document.getElementById('iosInstallPrompt').style.display = 'block';
                }, 3000);
            }
        }
        
        function closeIOSPrompt() {
            document.getElementById('iosInstallPrompt').style.display = 'none';
            localStorage.setItem('iosPromptShown', 'true');
        }
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„ØªØ«Ø¨ÙŠØª
        setTimeout(() => {
            if (!window.matchMedia('(display-mode: standalone)').matches && !localStorage.getItem('installBannerClosed')) {
                showInstallBanner();
            }
        }, 2000);

        // Phone
        function normalizePhone(p) { if (!p) return ''; let c = String(p).replace(/\D/g, ''); if (c.startsWith('966') && c.length === 12) c = '0' + c.substring(3); if (c.startsWith('5') && c.length === 9) c = '0' + c; return c; }
        function isValidPhone(p) { const n = normalizePhone(p); return n.length === 10 && n.startsWith('05'); }
        function validateLoginPhone() { const i = document.getElementById('loginPhone'), h = document.getElementById('loginPhoneHint'), b = document.getElementById('loginBtn'); i.value = i.value.replace(/\D/g, ''); const n = normalizePhone(i.value); if (!i.value.length) { i.className = ''; h.textContent = '10 Ø£Ø±Ù‚Ø§Ù… ØªØ¨Ø¯Ø£ Ø¨Ù€ 05'; h.className = 'input-hint'; b.disabled = true; } else if (isValidPhone(i.value)) { i.className = 'valid'; h.textContent = 'âœ“'; h.className = 'input-hint success'; b.disabled = false; } else { i.className = 'error'; h.textContent = n.length < 10 ? `${10-n.length} Ø£Ø±Ù‚Ø§Ù…` : 'ÙŠØ¬Ø¨ 05'; h.className = 'input-hint error'; b.disabled = true; } }
        function validateRegPhone() { const i = document.getElementById('regPhone'), h = document.getElementById('regPhoneHint'), b = document.getElementById('regBtn'), name = document.getElementById('regName').value.trim(); i.value = i.value.replace(/\D/g, ''); const n = normalizePhone(i.value), valid = isValidPhone(i.value) && name.length > 0; if (!i.value.length) { i.className = ''; h.textContent = '10 Ø£Ø±Ù‚Ø§Ù…'; h.className = 'input-hint'; } else if (isValidPhone(i.value)) { i.className = 'valid'; h.textContent = 'âœ“'; h.className = 'input-hint success'; } else { i.className = 'error'; h.textContent = n.length < 10 ? `${10-n.length}` : '05'; h.className = 'input-hint error'; } b.disabled = !valid; }

        // Auth
        function switchTab(t) { document.querySelectorAll('.tab').forEach(x => x.classList.remove('active')); document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active')); if (t === 'login') { document.querySelector('.tab:first-child').classList.add('active'); document.getElementById('loginTab').classList.add('active'); } else { document.querySelector('.tab:last-child').classList.add('active'); document.getElementById('registerTab').classList.add('active'); } }
        async function handleLogin(e) { 
            e.preventDefault(); 
            if (!isValidPhone(document.getElementById('loginPhone').value)) { 
                showToast('Ø±Ù‚Ù… Ø®Ø§Ø·Ø¦', 'error'); 
                return false; 
            } 
            const p = normalizePhone(document.getElementById('loginPhone').value); 
            showLoading(); 
            try {
                const r = await apiPost({ action: 'loginUser', phone: p }); 
                hideLoading(); 
                if (r.notFound) { 
                    showToast('ØºÙŠØ± Ù…Ø³Ø¬Ù„', 'warning'); 
                    switchTab('register'); 
                    document.getElementById('regPhone').value = p; 
                    validateRegPhone(); 
                    return false; 
                } 
                if (r.error) { 
                    showToast(r.error, 'error'); 
                    return false; 
                } 
                currentUser = r.user; 
                localStorage.setItem('currentUser', JSON.stringify(currentUser)); 
                updateUserUI(); 
                showPage('dashboardPage'); 
                showToast('Ù…Ø±Ø­Ø¨Ø§Ù‹ ' + currentUser.name + ' ğŸ‘‹'); 
                loadStationsCache(); 
                startOnlineTracking(); 
            } catch (err) {
                hideLoading();
                showToast('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ - ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª', 'error');
            }
            return false; 
        }
        async function handleRegister(e) { 
            e.preventDefault(); 
            const name = document.getElementById('regName').value.trim(); 
            if (!name || !isValidPhone(document.getElementById('regPhone').value)) { 
                showToast('ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error'); 
                return false; 
            } 
            const p = normalizePhone(document.getElementById('regPhone').value); 
            showLoading(); 
            try {
                const r = await apiPost({ action: 'registerUser', name, phone: p, email: document.getElementById('regEmail').value.trim(), userType: document.getElementById('regType').value }); 
                hideLoading(); 
                if (r.error && !r.alreadyExists) { 
                    showToast(r.error, 'error'); 
                    return false; 
                } 
                currentUser = r.user; 
                localStorage.setItem('currentUser', JSON.stringify(currentUser)); 
                updateUserUI(); 
                showPage('dashboardPage'); 
                showToast(r.alreadyExists ? 'Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ø¹ÙˆØ¯ØªÙƒ ğŸ‘‹' : 'ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ âœ“'); 
                loadStationsCache(); 
                startOnlineTracking(); 
            } catch (err) {
                hideLoading();
                showToast('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ - ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª', 'error');
            }
            return false; 
        }
        function updateUserUI() { document.getElementById('userName').textContent = currentUser.name; document.getElementById('userAvatar').textContent = currentUser.name.charAt(0); document.getElementById('userType').textContent = currentUser.type || 'Ù…ÙˆØ¸Ù'; }
        function showAdminLogin() { document.getElementById('adminLoginModal').classList.add('active'); }
        async function adminLogin() { const c = document.getElementById('adminCode').value; showLoading(); const r = await apiGet('getAdminCode'); hideLoading(); if (r.code && c === r.code) { closeModal('adminLoginModal'); showPage('adminPage'); loadAdminData(); } else { showToast('Ø±Ù…Ø² Ø®Ø§Ø·Ø¦', 'error'); } }
        function logout() { stopOnlineTracking(); currentUser = null; localStorage.removeItem('currentUser'); stopVersionCheck(); showPage('loginPage'); document.getElementById('loginPhone').value = ''; document.getElementById('loginBtn').disabled = true; showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬'); }
        function checkSession() { 
            const s = localStorage.getItem('currentUser'); 
            if (s) { 
                currentUser = JSON.parse(s); 
                updateUserUI(); 
                showPage('dashboardPage'); 
                loadStationsCache(); 
                startOnlineTracking(); 
                // ØªØ³Ø¬ÙŠÙ„ Ø²ÙŠØ§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø© (Ø¨Ø¯ÙˆÙ† Ø§Ù†ØªØ¸Ø§Ø±)
                apiPost({ action: 'recordVisit', phone: currentUser.phone, name: currentUser.name }).catch(() => {});
            } 
        }

        // Search
        let currentSearchedStation = null;
        let showFeederMode = false;
        
        async function searchStation() { 
            const v = document.getElementById('searchInput').value.trim(); 
            if (!v) { showToast('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù…', 'warning'); return; } 
            if (!isStationsLoaded) { showLoading(); await loadStationsCache(); hideLoading(); } 
            
            const r = searchStationLocal(v), rc = document.getElementById('resultsContent'), rn = document.getElementById('resultsCount'); 
            showFeederMode = false; 
            
            if (!r.found) { 
                rc.innerHTML = `<div class="not-found-card"><h4>ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</h4><div class="searched-number">${v}</div></div>`; 
                rn.textContent = '0'; 
                document.getElementById('mapSection').style.display = 'none'; 
                currentSearchedStation = null; 
            } else { 
                currentSearchedStation = r.station; 
                const s = r.station;
                const url = s.googleMap || (s.lat && s.lng ? `https://www.google.com/maps?q=${s.lat},${s.lng}` : '');
                const tb = s.type === 'distribution' ? '<span class="type-badge type-distribution">ØªÙˆØ²ÙŠØ¹</span>' : '<span class="type-badge type-substation">ØªØ­ÙˆÙŠÙ„</span>'; 
                
                // Ø²Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
                const editBtn = `<button class="action-btn btn-edit" style="padding:0.4rem 0.8rem;font-size:0.8rem;" onclick="openEditFromSearch()"><svg viewBox="0 0 24 24" style="width:1rem;height:1rem;"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg><span>ØªØ¹Ø¯ÙŠÙ„</span></button>`;
                
                let feederBtn = ''; 
                if (s.type === 'distribution' && s.feeder) { 
                    feederBtn = `<div class="feeder-toggle"><button class="feeder-btn active" id="nearbyBtn" onclick="toggleMapMode('nearby')"><svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/></svg>Ø§Ù„Ù‚Ø±ÙŠØ¨Ø© (3.5 ÙƒÙ…)</button><button class="feeder-btn" id="feederBtn" onclick="toggleMapMode('feeder')"><svg viewBox="0 0 24 24"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg>Ù…Ø­Ø·Ø§Øª Ø§Ù„Ù…ØºØ°ÙŠ (${s.feeder})</button></div>`; 
                } 
                
                let ex = s.type === 'distribution' ? `<tr><td colspan="4"><strong>Ø§Ù„Ù…ØºØ°ÙŠ:</strong> ${s.feeder||'-'} | <strong>Ø§Ù„Ø­ÙŠ:</strong> ${s.region||'-'}</td></tr>` : ''; 
                
                rc.innerHTML = `<div class="results-table-wrapper"><table class="results-table"><thead><tr><th>Ø§Ù„Ù…Ø­Ø·Ø©</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ø®Ø±ÙŠØ·Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead><tbody><tr><td><strong>${s.number}</strong></td><td>${tb}</td><td>${url ? `<a href="${url}" target="_blank" class="map-link"><svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/></svg>ÙØªØ­</a>` : '-'}</td><td>${editBtn}</td></tr>${ex}</tbody></table></div>${feederBtn}`; 
                
                rn.textContent = '1'; 
                if (s.lat && s.lng) { toggleMapMode('nearby'); } else { document.getElementById('mapSection').style.display = 'none'; } 
            } 
        }
        
        // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù…Ù† Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«
        function openEditFromSearch() {
            if (!currentSearchedStation) {
                showToast('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­Ø·Ø©', 'error');
                return;
            }
            
            const s = currentSearchedStation;
            editingStationType = s.type;
            
            // Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            document.getElementById('editStationNumber').value = s.number;
            
            if (s.type === 'distribution') {
                document.getElementById('editFeeder').value = s.feeder || '';
                document.getElementById('editRegion').value = s.region || '';
                document.getElementById('editFeederGroup').style.display = '';
                document.getElementById('editRegionGroup').style.display = '';
            } else {
                document.getElementById('editFeederGroup').style.display = 'none';
                document.getElementById('editRegionGroup').style.display = 'none';
            }
            
            document.getElementById('editLatitude').value = s.lat || '';
            document.getElementById('editLongitude').value = s.lng || '';
            document.getElementById('editReason').value = '';
            document.getElementById('editCoordsManual').value = '';
            document.getElementById('editLocationBtn').classList.remove('active');
            document.getElementById('editLocationBtn').innerHTML = '<svg viewBox="0 0 24 24"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4z"/></svg><span>ğŸ“ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ (GPS)</span>';
            
            // ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø©
            document.getElementById('editModal').classList.add('active');
        }
        
        function toggleMapMode(mode) {
            showFeederMode = (mode === 'feeder');
            const nearbyBtn = document.getElementById('nearbyBtn');
            const feederBtn = document.getElementById('feederBtn');
            
            if (nearbyBtn && feederBtn) {
                nearbyBtn.classList.toggle('active', !showFeederMode);
                feederBtn.classList.toggle('active', showFeederMode);
            }
            
            if (currentSearchedStation && currentSearchedStation.lat && currentSearchedStation.lng) {
                if (showFeederMode) {
                    loadFeederStations(currentSearchedStation);
                } else {
                    loadNearbyStationsLocal(currentSearchedStation.lat, currentSearchedStation.lng, currentSearchedStation.number);
                }
            }
        }
        
        function loadFeederStations(station) {
            const ms = document.getElementById('mapSection');
            if (!station.feeder) { ms.style.display = 'none'; return; }
            
            const feederStations = allStations.filter(s => 
                s.type === 'distribution' && 
                s.feeder === station.feeder && 
                s.number !== station.number &&
                s.lat && s.lng
            );
            
            if (!feederStations.length) { 
                ms.style.display = 'none'; 
                showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø·Ø§Øª Ø£Ø®Ø±Ù‰ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ØºØ°ÙŠ', 'warning');
                return; 
            }
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª
            feederStations.forEach(s => {
                s.distance = calcDistance(
                    parseFloat(station.lat), parseFloat(station.lng),
                    parseFloat(s.lat), parseFloat(s.lng)
                ).toFixed(2);
            });
            feederStations.sort((a, b) => parseFloat(a.distance) - parseFloat(b.distance));
            
            ms.style.display = 'block';
            document.getElementById('nearbyCount').textContent = feederStations.length + ' Ù…Ø­Ø·Ø©';
            document.querySelector('#mapSection .results-title h3').textContent = `Ù…Ø­Ø·Ø§Øª Ø§Ù„Ù…ØºØ°ÙŠ (${station.feeder})`;
            
            if (nearbyMap) nearbyMap.remove();
            nearbyMap = L.map('nearbyMap').setView([parseFloat(station.lat), parseFloat(station.lng)], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(nearbyMap);
            
            // Ø§Ù„Ù…Ø­Ø·Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ)
            L.marker([parseFloat(station.lat), parseFloat(station.lng)], {
                icon: L.divIcon({ html: '<div style="background:#e8a54b;width:20px;height:20px;border-radius:50%;border:3px solid white;box-shadow:0 2px 5px rgba(0,0,0,0.3);"></div>', iconSize: [20,20], iconAnchor: [10,10] })
            }).addTo(nearbyMap).bindPopup(`<b>${station.number}</b><br>Ø§Ù„Ù…Ø­Ø·Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©`);
            
            const markers = [[parseFloat(station.lat), parseFloat(station.lng)]];
            
            feederStations.forEach(s => {
                L.marker([parseFloat(s.lat), parseFloat(s.lng)], {
                    icon: L.divIcon({ html: '<div style="background:#5b8fb9;width:14px;height:14px;border-radius:50%;border:2px solid white;"></div>', iconSize: [14,14], iconAnchor: [7,7] })
                }).addTo(nearbyMap).bindPopup(`<b>${s.number}</b><br>${s.region || ''}<br>Ø§Ù„Ù…Ø³Ø§ÙØ©: ${s.distance} ÙƒÙ…`);
                markers.push([parseFloat(s.lat), parseFloat(s.lng)]);
            });
            
            // Ø¶Ø¨Ø· Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
            if (markers.length > 1) {
                nearbyMap.fitBounds(markers, { padding: [30, 30] });
            }
            
            document.getElementById('nearbyList').innerHTML = feederStations.map(s => {
                const u = s.googleMap || `https://www.google.com/maps?q=${s.lat},${s.lng}`;
                return `<div class="nearby-item"><div>ğŸ”· <span class="nearby-number">${s.number}</span> <span class="nearby-distance">${s.distance} ÙƒÙ…</span><br><small style="color:var(--text-secondary)">${s.region || ''}</small></div><a href="${u}" target="_blank" class="map-link"><svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/></svg></a></div>`;
            }).join('');
        }
        function loadNearbyStationsLocal(lat, lng, cur) { const ms = document.getElementById('mapSection'), nb = getNearbyStationsLocal(lat, lng, 3.5).filter(s => s.number !== cur); if (!nb.length) { ms.style.display = 'none'; return; } ms.style.display = 'block'; document.getElementById('nearbyCount').textContent = nb.length; document.querySelector('#mapSection .results-title h3').textContent = 'Ø§Ù„Ù…Ø­Ø·Ø§Øª Ø§Ù„Ù‚Ø±ÙŠØ¨Ø© (3.5 ÙƒÙ…)'; if (nearbyMap) nearbyMap.remove(); nearbyMap = L.map('nearbyMap').setView([parseFloat(lat), parseFloat(lng)], 14); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(nearbyMap); L.marker([parseFloat(lat), parseFloat(lng)], { icon: L.divIcon({ html: '<div style="background:#e8a54b;width:18px;height:18px;border-radius:50%;border:3px solid white;box-shadow:0 2px 5px rgba(0,0,0,0.3);"></div>', iconSize: [18, 18], iconAnchor: [9, 9] }) }).addTo(nearbyMap).bindPopup('<b>Ø§Ù„Ù…Ø­Ø·Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</b>'); nb.forEach(s => { if (s.lat && s.lng) { const c = s.type === 'substation' ? '#5b8fb9' : '#5cb85c'; L.marker([parseFloat(s.lat), parseFloat(s.lng)], { icon: L.divIcon({ html: `<div style="background:${c};width:14px;height:14px;border-radius:50%;border:2px solid white;"></div>`, iconSize: [14, 14], iconAnchor: [7, 7] }) }).addTo(nearbyMap).bindPopup(`<b>${s.number}</b><br>${s.typeLabel||''}<br>${s.distance} ÙƒÙ…`); } }); document.getElementById('nearbyList').innerHTML = nb.map(s => { const u = s.googleMap || `https://www.google.com/maps?q=${s.lat},${s.lng}`, ico = s.type === 'substation' ? 'ğŸ”·' : 'ğŸŸ¢'; return `<div class="nearby-item"><div>${ico} <span class="nearby-number">${s.number}</span> <span class="nearby-distance">${s.distance} ÙƒÙ…</span></div><a href="${u}" target="_blank" class="map-link"><svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/></svg></a></div>`; }).join(''); }

        // Add
        function openAddModal(t) { 
            if (t === 'distribution') { 
                document.getElementById('addDistributionModal').classList.add('active'); 
                ['addDistNumber', 'addDistFeeder', 'addDistRegion', 'addDistLat', 'addDistLng', 'addDistReason', 'addDistCoordsManual'].forEach(id => { 
                    const el = document.getElementById(id); 
                    if (el) el.value = ''; 
                }); 
                document.getElementById('addDistLocationBtn').classList.remove('active');
                document.getElementById('addDistLocationBtn').innerHTML = '<svg viewBox="0 0 24 24"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06z"/></svg><span>ğŸ“ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ (GPS)</span>';
            } else { 
                document.getElementById('addSubstationModal').classList.add('active'); 
                ['addSubShortName', 'addSubLat', 'addSubLng', 'addSubReason', 'addSubCoordsManual'].forEach(id => { 
                    const el = document.getElementById(id); 
                    if (el) el.value = ''; 
                }); 
                document.getElementById('addSubLocationBtn').classList.remove('active');
                document.getElementById('addSubLocationBtn').innerHTML = '<svg viewBox="0 0 24 24"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06z"/></svg><span>ğŸ“ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ (GPS)</span>';
            } 
        }
        function getCurrentLocation(pfx) { const btn = document.getElementById(pfx + 'LocationBtn'), lat = document.getElementById(pfx + 'Lat') || document.getElementById(pfx + 'Latitude'), lng = document.getElementById(pfx + 'Lng') || document.getElementById(pfx + 'Longitude'); btn.innerHTML = '<div class="spinner"></div><span>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ¯...</span>'; if (navigator.geolocation) { navigator.geolocation.getCurrentPosition(p => { lat.value = p.coords.latitude.toFixed(8); lng.value = p.coords.longitude.toFixed(8); btn.classList.add('active'); btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg><span>ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ¯ âœ“</span>'; showToast('ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù†Ø¬Ø§Ø­'); // Ù…Ø³Ø­ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ const manualInput = document.getElementById(pfx + 'CoordsManual'); if (manualInput) manualInput.value = ''; }, () => { btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4z"/></svg><span>ğŸ“ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ (GPS)</span>'; showToast('ÙØ´Ù„ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹', 'error'); }, { enableHighAccuracy: true, timeout: 15000 }); } }
        
        // ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ù…Ø¯Ø®Ù„Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹
        function parseManualCoords(pfx) {
            const manualInput = document.getElementById(pfx + 'CoordsManual');
            const latInput = document.getElementById(pfx + 'Lat') || document.getElementById(pfx + 'Latitude');
            const lngInput = document.getElementById(pfx + 'Lng') || document.getElementById(pfx + 'Longitude');
            const btn = document.getElementById(pfx + 'LocationBtn');
            
            if (!manualInput || !latInput || !lngInput) return;
            
            let value = manualInput.value.trim();
            
            if (!value) {
                showToast('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø£ÙˆÙ„Ø§Ù‹', 'warning');
                manualInput.classList.add('invalid');
                setTimeout(() => manualInput.classList.remove('invalid'), 2000);
                return;
            }
            
            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø¯Ø®Ù„ - Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ø§Ù„Ø²Ø§Ø¦Ø¯Ø©
            value = value.replace(/\s+/g, '');
            
            // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª
            // Ø§Ù„ØµÙŠØº Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø©:
            // 21.5234,39.1876
            // 21.5234 , 39.1876
            // 21.5234, 39.1876
            
            let lat, lng;
            
            if (value.includes(',')) {
                const parts = value.split(',');
                if (parts.length === 2) {
                    lat = parseFloat(parts[0].trim());
                    lng = parseFloat(parts[1].trim());
                }
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª
            if (isNaN(lat) || isNaN(lng)) {
                showToast('ØµÙŠØºØ© Ø®Ø§Ø·Ø¦Ø©! Ø§Ø³ØªØ®Ø¯Ù…: 21.5234,39.1876', 'error');
                manualInput.classList.add('invalid');
                setTimeout(() => manualInput.classList.remove('invalid'), 2000);
                return;
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª (Ù„Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹)
            // Ø®Ø· Ø§Ù„Ø¹Ø±Ø¶: 16 - 32
            // Ø®Ø· Ø§Ù„Ø·ÙˆÙ„: 34 - 56
            if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                showToast('Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ù…Ø³Ù…ÙˆØ­', 'error');
                manualInput.classList.add('invalid');
                setTimeout(() => manualInput.classList.remove('invalid'), 2000);
                return;
            }
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª
            latInput.value = lat.toFixed(8);
            lngInput.value = lng.toFixed(8);
            
            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø²Ø±
            if (btn) {
                btn.classList.add('active');
                btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg><span>ØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª âœ“</span>';
            }
            
            // ØªØ£ÙƒÙŠØ¯ Ø¨ØµØ±ÙŠ
            manualInput.classList.add('valid');
            setTimeout(() => manualInput.classList.remove('valid'), 3000);
            
            showToast('ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª âœ“');
            
            // Ø¹Ø±Ø¶ Ø±Ø§Ø¨Ø· Google Maps Ù„Ù„ØªØ£ÙƒØ¯
            const mapUrl = `https://www.google.com/maps?q=${lat},${lng}`;
            console.log('Google Maps Link:', mapUrl);
        }
        async function submitAddDistribution() { const n = document.getElementById('addDistNumber').value.trim(), rg = document.getElementById('addDistRegion').value.trim(); if (!n || !rg) { showToast('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error'); return; } if (searchStationLocal(n).found) { showToast('Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹', 'error'); return; } const fd = document.getElementById('addDistFeeder').value.trim(), lt = document.getElementById('addDistLat').value, lg = document.getElementById('addDistLng').value, rs = document.getElementById('addDistReason').value.trim(); closeModal('addDistributionModal'); showToast('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ©...', 'warning'); const ns = { number: n, feeder: fd, region: rg, lat: lt, lng: lg, type: 'distribution', typeLabel: 'ØªÙˆØ²ÙŠØ¹', googleMap: (lt && lg) ? `https://www.google.com/maps?q=${lt},${lg}` : '' }; allStations.push(ns); updateCacheStatus('loaded', allStations.length + ' âœ“'); const r = await apiPost({ action: 'addStation', number: n, region: rg, feeder: fd, lat: lt, lng: lg, reason: rs, userName: currentUser?.name || '', userEmail: currentUser?.email || '', userPhone: currentUser?.phone || '' }); if (r.error) { allStations = allStations.filter(s => s.number !== n); updateCacheStatus('loaded', allStations.length + ' âœ“'); showToast(r.error, 'error'); return; } localStorage.setItem(CACHE_KEY, JSON.stringify(allStations)); showToast('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© âœ“'); document.getElementById('searchInput').value = n; searchStation(); }
        async function submitAddSubstation() { const sn = document.getElementById('addSubShortName').value.trim().toUpperCase(); if (!sn) { showToast('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø®ØªØµØ§Ø±', 'error'); return; } if (searchStationLocal(sn).found) { showToast('Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹', 'error'); return; } const lt = document.getElementById('addSubLat').value, lg = document.getElementById('addSubLng').value, rs = document.getElementById('addSubReason').value.trim(); closeModal('addSubstationModal'); showToast('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ©...', 'warning'); const ns = { number: sn, shortName: sn, lat: lt, lng: lg, type: 'substation', typeLabel: 'ØªØ­ÙˆÙŠÙ„', googleMap: (lt && lg) ? `https://www.google.com/maps?q=${lt},${lg}` : '' }; allStations.push(ns); updateCacheStatus('loaded', allStations.length + ' âœ“'); const r = await apiPost({ action: 'addSubstation', shortName: sn, lat: lt, lng: lg, reason: rs, userName: currentUser?.name || '', userEmail: currentUser?.email || '', userPhone: currentUser?.phone || '' }); if (r.error) { allStations = allStations.filter(s => s.number !== sn); updateCacheStatus('loaded', allStations.length + ' âœ“'); showToast(r.error, 'error'); return; } localStorage.setItem(CACHE_KEY, JSON.stringify(allStations)); showToast('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© âœ“'); document.getElementById('searchInput').value = sn; searchStation(); }
        async function submitEdit() { 
            const n = document.getElementById('editStationNumber').value.trim(); 
            if (!n) { showToast('Ø®Ø·Ø£ ÙÙŠ Ø±Ù‚Ù… Ø§Ù„Ù…Ø­Ø·Ø©', 'error'); return; } 
            
            const lt = document.getElementById('editLatitude').value.trim();
            const lg = document.getElementById('editLongitude').value.trim();
            const rs = document.getElementById('editReason').value.trim(); 
            
            closeModal('editModal'); 
            showToast('Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„...', 'warning'); 
            
            const idx = allStations.findIndex(s => String(s.number).toUpperCase() === n.toUpperCase());
            if (idx === -1) { showToast('Ø§Ù„Ù…Ø­Ø·Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©', 'error'); return; }
            
            const old = { ...allStations[idx] }; 
            
            if (editingStationType === 'distribution') { 
                allStations[idx].feeder = document.getElementById('editFeeder').value.trim(); 
                allStations[idx].region = document.getElementById('editRegion').value.trim(); 
            } 
            if (lt && lg) { 
                allStations[idx].lat = lt; 
                allStations[idx].lng = lg; 
                allStations[idx].googleMap = `https://www.google.com/maps?q=${lt},${lg}`; 
            } 
            
            const act = editingStationType === 'distribution' ? 'editStation' : 'editSubstation';
            const data = editingStationType === 'distribution' 
                ? { action: act, number: n, feeder: document.getElementById('editFeeder').value.trim(), region: document.getElementById('editRegion').value.trim(), lat: lt, lng: lg, reason: rs, userName: currentUser?.name || '', userEmail: currentUser?.email || '', userPhone: currentUser?.phone || '' } 
                : { action: act, shortName: n, lat: lt, lng: lg, reason: rs, userName: currentUser?.name || '', userEmail: currentUser?.email || '', userPhone: currentUser?.phone || '' }; 
            
            const r = await apiPost(data); 
            
            if (r.error) { 
                allStations[idx] = old; 
                showToast(r.error, 'error'); 
                return; 
            } 
            
            localStorage.setItem(CACHE_KEY, JSON.stringify(allStations)); 
            showToast('ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ âœ“', 'success'); 
            document.getElementById('searchInput').value = n; 
            searchStation(); 
        }

        // Fault
        function openFaultModal() { document.getElementById('faultModal').classList.add('active'); for (let i = 1; i <= 6; i++) { const inp = document.getElementById('fault' + i); inp.value = ''; inp.classList.remove('found', 'not-found'); } document.getElementById('faultResults').style.display = 'none'; faultStations = []; }
        async function searchFaultStations() { 
            const nums = []; 
            for (let i = 1; i <= 6; i++) { 
                const v = document.getElementById('fault' + i).value.trim(); 
                if (v) nums.push({ i, v }); 
            } 
            if (nums.length < 2) { showToast('Ø£Ø¯Ø®Ù„ 2 Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'warning'); return; } 
            if (!isStationsLoaded) { showLoading(); await loadStationsCache(); hideLoading(); } 
            
            faultStations = []; 
            const tb = document.getElementById('faultTableBody'); 
            tb.innerHTML = ''; 
            const lbl = ['A', 'B', 'C', 'D', 'E', 'F']; 
            let fc = 0; 
            
            for (const item of nums) { 
                const inp = document.getElementById('fault' + item.i);
                
                // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø¯Ø®Ù„ Ù„Ù„Ø¨Ø­Ø«
                let searchVal = item.v;
                
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¨Ø­Ø«
                const r = searchStationLocal(searchVal); 
                
                if (r.found) { 
                    inp.classList.remove('not-found'); 
                    inp.classList.add('found'); 
                    r.station.label = lbl[fc]; 
                    faultStations.push(r.station); 
                    fc++; 
                    const tl = r.station.type === 'substation' ? '<span class="type-badge type-substation">ØªØ­ÙˆÙŠÙ„</span>' : '<span class="type-badge type-distribution">ØªÙˆØ²ÙŠØ¹</span>'; 
                    tb.innerHTML += `<tr><td><span class="point-label">${r.station.label}</span></td><td><strong>${r.station.number}</strong></td><td>${tl}</td><td><span class="status-found">âœ“</span></td></tr>`; 
                } else { 
                    inp.classList.remove('found'); 
                    inp.classList.add('not-found'); 
                    tb.innerHTML += `<tr><td>-</td><td><strong>${item.v}</strong></td><td>-</td><td><span class="status-not-found">âœ•</span></td></tr>`; 
                } 
            } 
            
            document.getElementById('faultCount').textContent = fc; 
            document.getElementById('faultResults').style.display = 'block'; 
            
            if (fc >= 1) { 
                renderFaultMap(); 
                generateNavigationLink(); 
                calculateTotalDistance(); 
            } else { 
                showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬', 'warning'); 
            } 
        }
        function calculateTotalDistance() { const vs = faultStations.filter(s => s.lat && s.lng); if (vs.length < 2) { document.getElementById('totalDistance').innerHTML = ''; return; } let td = 0; for (let i = 0; i < vs.length - 1; i++) td += calcDistance(parseFloat(vs[i].lat), parseFloat(vs[i].lng), parseFloat(vs[i+1].lat), parseFloat(vs[i+1].lng)); document.getElementById('totalDistance').innerHTML = `<span class="distance-badge">ğŸ“ Ø§Ù„Ù…Ø³Ø§ÙØ©: ${td.toFixed(2)} ÙƒÙ…</span>`; }
        function renderFaultMap() { const vs = faultStations.filter(s => s.lat && s.lng); if (!vs.length) { showToast('Ù„Ø§ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª', 'warning'); return; } if (faultMap) faultMap.remove(); let sLat = 0, sLng = 0; vs.forEach(s => { sLat += parseFloat(s.lat); sLng += parseFloat(s.lng); }); const cLat = sLat / vs.length, cLng = sLng / vs.length, zm = vs.length === 1 ? 15 : 13; faultMap = L.map('faultMap').setView([cLat, cLng], zm); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(faultMap); const cols = { distribution: '#e8a54b', substation: '#5b8fb9' }, mks = []; vs.forEach(s => { const c = cols[s.type] || '#e8a54b'; L.marker([parseFloat(s.lat), parseFloat(s.lng)], { icon: L.divIcon({ html: `<div style="background:${c};width:30px;height:30px;border-radius:50%;border:3px solid white;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;box-shadow:0 2px 8px rgba(0,0,0,0.3);">${s.label}</div>`, iconSize: [30, 30], iconAnchor: [15, 15] }) }).addTo(faultMap).bindPopup(`<b>${s.label} - ${s.number}</b><br>${s.typeLabel||''}`); mks.push([parseFloat(s.lat), parseFloat(s.lng)]); }); if (mks.length >= 2) { L.polyline(mks, { color: '#e8a54b', weight: 3, dashArray: '10, 10' }).addTo(faultMap); faultMap.fitBounds(mks, { padding: [30, 30] }); } }
        function generateNavigationLink() { const vs = faultStations.filter(s => s.lat && s.lng); if (!vs.length) { document.getElementById('faultNavigationLink').style.display = 'none'; return; } let url; if (vs.length === 1) { url = `https://www.google.com/maps/search/?api=1&query=${vs[0].lat},${vs[0].lng}`; } else { url = 'https://www.google.com/maps/dir/'; vs.forEach((s, i) => { url += `${s.lat},${s.lng}`; if (i < vs.length - 1) url += '/'; }); } const lnk = document.getElementById('faultNavigationLink'); lnk.href = url; lnk.style.display = 'flex'; lnk.innerHTML = vs.length === 1 ? '<svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/></svg>ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹' : '<svg viewBox="0 0 24 24"><path d="M21.71 11.29l-9-9c-.39-.39-1.02-.39-1.41 0l-9 9c-.39.39-.39 1.02 0 1.41l9 9c.39.39 1.02.39 1.41 0l9-9c.39-.38.39-1.01 0-1.41z"/></svg>ÙØªØ­ Ø§Ù„ØªÙ†Ù‚Ù„'; }

        // Admin
        async function loadAdminData() { 
            showLoading(); 
            
            const stats = await apiGet('getStats'); 
            if (stats.stats) { 
                document.getElementById('totalDistribution').textContent = stats.stats.totalDistribution || 0; 
                document.getElementById('totalSubstations').textContent = stats.stats.totalSubstations || 0; 
                document.getElementById('totalUsers').textContent = stats.stats.totalUsers || 0; 
                document.getElementById('totalAdditions').textContent = stats.stats.totalAdditions || 0; 
                document.getElementById('totalEdits').textContent = stats.stats.totalEdits || 0; 
                document.getElementById('onlineCount').textContent = stats.stats.onlineCount || 0;
            } 
            
            // Ø¬Ù„Ø¨ Ø§Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹
            const online = await apiGet('getOnlineUsers');
            if (online.success) {
                document.getElementById('onlineBadge').textContent = online.count || 0;
                const onlineList = document.getElementById('onlineUsersList');
                if (online.users && online.users.length > 0) {
                    onlineList.innerHTML = online.users.map(u => {
                        const initial = u.name ? u.name.charAt(0) : '?';
                        const timeParts = u.lastActive ? u.lastActive.split(' ')[1] : '';
                        return `<div class="online-user-card">
                            <div class="online-user-avatar">${initial}</div>
                            <div class="online-user-info">
                                <div class="online-user-name">${u.name || 'Ù…Ø³ØªØ®Ø¯Ù…'}</div>
                                <div class="online-user-time">ğŸ• ${timeParts || 'Ø§Ù„Ø¢Ù†'}</div>
                            </div>
                            <div class="online-indicator"></div>
                        </div>`;
                    }).join('');
                } else {
                    onlineList.innerHTML = '<div class="empty-online">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØªÙˆØ§Ø¬Ø¯ÙˆÙ† Ø­Ø§Ù„ÙŠØ§Ù‹</div>';
                }
            }
            
            const daily = await apiGet('getDailyStats'); 
            if (daily.success) renderCharts(daily); 
            
            const users = await apiGet('getUsers'); 
            if (users.users) document.getElementById('adminUsersBody').innerHTML = users.users.map(u => `<tr><td>${u.name}</td><td>${u.phone}</td><td>${u.type||'Ù…ÙˆØ¸Ù'}</td><td>${u.registerDate||'-'}</td></tr>`).join(''); 
            
            const logs = await apiGet('getLogs'); 
            if (logs.logs) document.getElementById('adminLogsBody').innerHTML = logs.logs.slice(-30).reverse().map(l => `<tr><td style="color:${l.type.includes('Ø¥Ø¶Ø§ÙØ©') ? 'var(--success)' : 'var(--warning)'}">${l.type}</td><td>${l.station}</td><td>${l.user}</td><td>${l.date}</td></tr>`).join(''); 
            
            hideLoading(); 
            
            // ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙŠÙ† ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
            setTimeout(refreshOnlineUsers, 30000);
        }
        
        async function refreshOnlineUsers() {
            if (document.getElementById('adminPage').classList.contains('active')) {
                const online = await apiGet('getOnlineUsers');
                if (online.success) {
                    document.getElementById('onlineBadge').textContent = online.count || 0;
                    document.getElementById('onlineCount').textContent = online.count || 0;
                    const onlineList = document.getElementById('onlineUsersList');
                    if (online.users && online.users.length > 0) {
                        onlineList.innerHTML = online.users.map(u => {
                            const initial = u.name ? u.name.charAt(0) : '?';
                            const timeParts = u.lastActive ? u.lastActive.split(' ')[1] : '';
                            return `<div class="online-user-card">
                                <div class="online-user-avatar">${initial}</div>
                                <div class="online-user-info">
                                    <div class="online-user-name">${u.name || 'Ù…Ø³ØªØ®Ø¯Ù…'}</div>
                                    <div class="online-user-time">ğŸ• ${timeParts || 'Ø§Ù„Ø¢Ù†'}</div>
                                </div>
                                <div class="online-indicator"></div>
                            </div>`;
                        }).join('');
                    } else {
                        onlineList.innerHTML = '<div class="empty-online">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØªÙˆØ§Ø¬Ø¯ÙˆÙ† Ø­Ø§Ù„ÙŠØ§Ù‹</div>';
                    }
                }
                setTimeout(refreshOnlineUsers, 30000);
            }
        }
        function renderCharts(d) { new Chart(document.getElementById('visitsChart'), { type: 'line', data: { labels: d.dailyVisits.map(x => x.date.slice(5)), datasets: [{ label: 'Ø²ÙŠØ§Ø±Ø§Øª', data: d.dailyVisits.map(x => x.count), borderColor: '#e8a54b', backgroundColor: 'rgba(232,165,75,0.2)', fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { color: '#c5ddf0' }, grid: { color: '#5b8fb9' } }, x: { ticks: { color: '#c5ddf0' }, grid: { color: '#5b8fb9' } } } } }); new Chart(document.getElementById('activityChart'), { type: 'bar', data: { labels: d.dailyActivity.map(x => x.date.slice(5)), datasets: [{ label: 'Ø¥Ø¶Ø§ÙØ§Øª', data: d.dailyActivity.map(x => x.additions), backgroundColor: '#5cb85c' }, { label: 'ØªØ¹Ø¯ÙŠÙ„Ø§Øª', data: d.dailyActivity.map(x => x.edits), backgroundColor: '#e8a54b' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#c5ddf0' } } }, scales: { y: { beginAtZero: true, ticks: { color: '#c5ddf0' }, grid: { color: '#5b8fb9' } }, x: { ticks: { color: '#c5ddf0' }, grid: { color: '#5b8fb9' } } } } }); }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            checkSession();
            checkIOSInstall();
            loadContactPhone(); // Ø¬Ù„Ø¨ Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„
        });
        document.querySelectorAll('.modal-overlay').forEach(m => m.addEventListener('click', e => { if (e.target === m) m.classList.remove('active'); }));
    </script>
</body>
</html>
